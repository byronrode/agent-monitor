<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Monitor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #09090b;
    --surface: #111113;
    --surface-2: #1a1a1f;
    --surface-3: #222228;
    --border: #27272a;
    --border-hover: #3f3f46;
    --text: #fafafa;
    --text-2: #a1a1aa;
    --text-3: #71717a;
    --green: #22c55e;
    --green-bg: rgba(34,197,94,0.1);
    --amber: #f59e0b;
    --amber-bg: rgba(245,158,11,0.1);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.1);
    --blue: #3b82f6;
    --blue-bg: rgba(59,130,246,0.1);
    --purple: #a855f7;
    --purple-bg: rgba(168,85,247,0.08);
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Inter', system-ui, -apple-system, sans-serif;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
  }

  /* Top bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 1rem 2rem;
    border-bottom: 1px solid var(--border);
    background: var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .topbar-left { display: flex; align-items: center; gap: 1rem; }
  .topbar-left h1 { font-size: 1rem; font-weight: 600; letter-spacing: -0.01em; }
  .topbar-left .subtitle { color: var(--text-3); font-size: 0.8rem; font-family: var(--mono); }

  .topbar-right { display: flex; align-items: center; gap: 1rem; }

  .refresh-controls {
    display: flex; align-items: center; gap: 0.5rem;
    font-family: var(--mono); font-size: 0.75rem; color: var(--text-3);
  }

  select, button.btn {
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }

  select:hover, button.btn:hover { border-color: var(--border-hover); background: var(--surface-3); }
  button.btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .live-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* Layout */
  .layout {
    display: flex;
    min-height: calc(100vh - 53px);
  }

  /* Sidebar — agent lanes */
  .sidebar {
    width: 220px;
    border-right: 1px solid var(--border);
    background: var(--surface);
    padding: 1rem 0;
    flex-shrink: 0;
  }

  .sidebar-title {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
    padding: 0 1rem;
    margin-bottom: 0.75rem;
  }

  .agent-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.85rem;
  }

  .agent-item:hover { background: var(--surface-2); }
  .agent-item.active { background: var(--surface-2); border-right: 2px solid var(--blue); }

  .agent-item .dot {
    width: 8px; height: 8px; border-radius: 50%;
    flex-shrink: 0;
  }

  .agent-item .count {
    margin-left: auto;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
    background: var(--surface-3);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
  }

  /* Main content */
  .main {
    flex: 1;
    padding: 1.5rem 2rem;
    overflow-y: auto;
  }

  /* Stats row */
  .stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: 0.75rem;
    margin-bottom: 2rem;
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
  }

  .stat .label { font-size: 0.7rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.08em; }
  .stat .value { font-size: 1.75rem; font-weight: 700; font-family: var(--mono); margin-top: 0.25rem; }
  .stat .detail { font-size: 0.7rem; color: var(--text-3); font-family: var(--mono); margin-top: 0.15rem; }

  /* Run list */
  .section-header {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
  }

  .section-header .pill {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.1rem 0.5rem;
    font-family: var(--mono);
  }

  .run-list { display: flex; flex-direction: column; gap: 0.5rem; margin-bottom: 2rem; }

  .run-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
    cursor: pointer;
  }

  .run-card:hover { border-color: var(--border-hover); }

  .run-card-header {
    display: grid;
    grid-template-columns: 90px 1fr auto;
    gap: 1rem;
    padding: 1rem 1.25rem;
    align-items: center;
  }

  .run-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge.running { background: var(--green-bg); color: var(--green); }
  .badge.done { background: var(--blue-bg); color: var(--blue); }
  .badge.failed { background: var(--red-bg); color: var(--red); }
  .badge.timeout { background: var(--amber-bg); color: var(--amber); }
  .badge.unknown { background: var(--surface-3); color: var(--text-3); }

  .run-status .time {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
  }

  .run-info { min-width: 0; }

  .run-info .title-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .run-info .name { font-weight: 600; font-size: 0.9rem; }

  .run-info .agent-tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    padding: 0.1rem 0.5rem;
    border-radius: 3px;
    background: var(--purple-bg);
    color: var(--purple);
  }

  .run-info .model-tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    padding: 0.1rem 0.5rem;
    border-radius: 3px;
    background: var(--surface-3);
    color: var(--text-2);
  }

  .run-info .task-preview {
    font-size: 0.8rem;
    color: var(--text-2);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .run-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.2rem;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
    white-space: nowrap;
  }

  /* Expanded detail */
  .run-detail {
    border-top: 1px solid var(--border);
    padding: 1.25rem;
    display: none;
  }

  .run-detail.open { display: block; }

  .detail-section {
    margin-bottom: 1.25rem;
  }

  .detail-section:last-child { margin-bottom: 0; }

  .detail-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
    margin-bottom: 0.5rem;
  }

  .detail-prompt {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    font-family: var(--mono);
    font-size: 0.75rem;
    line-height: 1.6;
    color: var(--text-2);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 400px;
    overflow-y: auto;
  }

  .transcript-msg {
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
    line-height: 1.5;
  }

  .transcript-msg.assistant {
    background: var(--surface-2);
    border-left: 2px solid var(--blue);
  }

  .transcript-msg.user {
    background: var(--surface-2);
    border-left: 2px solid var(--green);
  }

  .transcript-msg .msg-role {
    font-family: var(--mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    color: var(--text-3);
    margin-bottom: 0.25rem;
  }

  .transcript-msg .msg-text {
    color: var(--text-2);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .tool-call {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--amber);
    background: var(--amber-bg);
    padding: 0.2rem 0.5rem;
    border-radius: 3px;
    display: inline-block;
    margin: 0.15rem 0;
  }

  .empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-3);
  }

  .status-banner {
    display: none;
    margin-bottom: 1rem;
    padding: 0.75rem 1rem;
    border-radius: 8px;
    border: 1px solid var(--border);
    font-size: 0.8rem;
  }

  .status-banner.error {
    display: block;
    border-color: var(--red);
    background: var(--red-bg);
    color: #fecaca;
  }

  .status-banner.info {
    display: block;
    border-color: var(--blue);
    background: var(--blue-bg);
    color: #bfdbfe;
  }

  .filters {
    display: grid;
    grid-template-columns: repeat(4, minmax(0, 1fr));
    gap: 0.75rem;
    margin-bottom: 1rem;
  }

  .filters input, .filters select { width: 100%; }

  .token-dashboard {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.75rem;
    margin-bottom: 1.5rem;
  }

  .token-breakdown {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
  }

  .token-breakdown .title {
    font-size: 0.7rem;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }

  .token-breakdown .row {
    display:flex; justify-content:space-between; gap:0.5rem;
    font-family: var(--mono); font-size:0.72rem; color: var(--text-2);
    padding: 0.15rem 0;
  }

  .token-chips { display:flex; flex-wrap:wrap; gap:0.3rem; margin-top:0.4rem; }
  .chip {
    font-family: var(--mono);
    font-size: 0.62rem;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.12rem 0.45rem;
    color: var(--text-2);
    background: var(--surface-2);
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    gap: 0;
    border: 1px solid var(--border);
    border-radius: 6px;
    overflow: hidden;
  }

  .view-toggle button {
    background: var(--surface-2);
    border: none;
    border-right: 1px solid var(--border);
    color: var(--text-3);
    font-family: var(--mono);
    font-size: 0.7rem;
    padding: 0.4rem 0.75rem;
    cursor: pointer;
  }

  .view-toggle button:last-child { border-right: none; }
  .view-toggle button.active { background: var(--surface-3); color: var(--text); }
  .view-toggle button:hover { background: var(--surface-3); }

  /* Lanes view */
  .lanes {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 1rem;
  }

  .lane {
    min-width: 320px;
    max-width: 400px;
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .lane-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface-2);
  }

  .lane-header .lane-name { font-weight: 600; font-size: 0.85rem; }
  .lane-header .lane-count { font-family: var(--mono); font-size: 0.7rem; color: var(--text-3); }

  .lane-body { padding: 0.5rem; max-height: 70vh; overflow-y: auto; }

  .lane-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 0.75rem;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .lane-card:hover { border-color: var(--border-hover); }

  .lane-card .lc-top {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.35rem;
  }

  .lane-card .lc-label { font-weight: 600; font-size: 0.8rem; }
  .lane-card .lc-task { font-size: 0.75rem; color: var(--text-2); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .lane-card .lc-bottom { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.35rem; font-family: var(--mono); font-size: 0.65rem; color: var(--text-3); }
  /* ── Mobile ── */
  @media (max-width: 767px) {
    /* Stack layout vertically */
    .layout { flex-direction: column; min-height: auto; }

    /* Topbar: compact */
    .topbar { padding: 0.75rem 1rem; }
    .topbar-left h1 { font-size: 0.9rem; }
    .topbar-left .subtitle { font-size: 0.7rem; }
    .topbar-right { gap: 0.5rem; }
    .topbar-right .btn { padding: 0.3rem 0.6rem; font-size: 0.7rem; }
    .topbar-right select { padding: 0.3rem 0.5rem; font-size: 0.7rem; }

    /* Sidebar → horizontal scrollable pill bar */
    .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding: 0;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-title { display: none; }
    #agentList {
      display: flex;
      flex-wrap: nowrap;
      padding: 0.5rem 0.75rem;
      gap: 0.25rem;
    }
    .sidebar .agent-item {
      flex-shrink: 0;
      white-space: nowrap;
      padding: 0.3rem 0.65rem;
      font-size: 0.75rem;
      border-radius: 6px;
      border-right: none !important;
    }
    .sidebar .agent-item.active {
      background: var(--surface-3);
      border-right: none !important;
      border-bottom: none;
    }

    /* Main content */
    .main { padding: 1rem; }
    .filters { grid-template-columns: 1fr 1fr; gap: 0.5rem; }
    .token-dashboard { grid-template-columns: 1fr; }

    /* Stats: 2×2 + 1 */
    .stats {
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
      margin-bottom: 1.25rem;
    }
    .stat { padding: 0.75rem; }
    .stat .label { font-size: 0.6rem; }
    .stat .value { font-size: 1.4rem; }

    /* Run cards: stack the 3-col grid */
    .run-card-header {
      grid-template-columns: 1fr;
      gap: 0.5rem;
      padding: 0.85rem 1rem;
    }
    .run-status {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
    }
    .run-meta {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .run-info .title-row { flex-wrap: wrap; gap: 0.35rem; }

    /* Lanes: stack vertically */
    .lanes { flex-direction: column; }
    .lane { min-width: 100%; max-width: 100%; }

    /* Detail panels */
    .run-detail { padding: 0.85rem; }
    .detail-prompt { font-size: 0.7rem; max-height: 250px; }
  }

  @media (max-width: 400px) {
    .topbar { padding: 0.5rem 0.75rem; }
    .topbar-left h1 { font-size: 0.8rem; }
    .view-toggle button { padding: 0.3rem 0.5rem; font-size: 0.65rem; }
    .main { padding: 0.75rem; }
    .stats { gap: 0.35rem; }
    .stat { padding: 0.5rem; }
    .stat .value { font-size: 1.15rem; }
    .run-card-header { padding: 0.7rem; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <h1>Agent Monitor</h1>
    <span class="subtitle" id="lastUpdate"></span>
  </div>
  <div class="topbar-right">
    <div class="view-toggle">
      <button class="active" onclick="setView('list')" id="viewList">List</button>
      <button onclick="setView('lanes')" id="viewLanes">Lanes</button>
    </div>
    <div class="refresh-controls">
      <div class="live-dot" id="liveDot"></div>
      <select id="refreshInterval" onchange="setRefreshInterval()">
        <option value="0">manual</option>
        <option value="5">5s</option>
        <option value="10" selected>10s</option>
        <option value="30">30s</option>
      </select>
    </div>
    <button class="btn" onclick="refresh()" id="refreshBtn">↻ Refresh</button>
  </div>
</div>

<div class="layout">
  <div class="sidebar">
    <div class="sidebar-title">Agents</div>
    <div id="agentList"></div>
  </div>
  <div class="main" id="mainContent">
    <div id="statusBanner" class="status-banner"></div>
    <div class="stats" id="stats"></div>
    <div class="filters" id="filters">
      <input id="searchInput" placeholder="Search label/task/model" />
      <select id="statusFilter">
        <option value="all">all statuses</option>
        <option value="running">running</option>
        <option value="done">done</option>
        <option value="failed">failed</option>
        <option value="timeout">timeout</option>
      </select>
      <select id="timeWindow">
        <option value="0">all time</option>
        <option value="1">last 1h</option>
        <option value="6">last 6h</option>
        <option value="24" selected>last 24h</option>
        <option value="168">last 7d</option>
      </select>
      <button class="btn" onclick="clearFilters()">Clear filters</button>
    </div>
    <div class="token-dashboard" id="tokenDashboard"></div>
    <div id="content"></div>
  </div>
</div>

<script>
let runs = [];
let agents = [];
let activeAgent = null; // null = all
let currentView = 'list';
let statusFilter = 'all';
let searchQuery = '';
let timeWindowHours = 24;
let refreshTimer = null;
let expandedRuns = {};
let runsTotal = 0;
let lastError = '';
const PAGE_SIZE = 200;
const STORAGE_KEY = 'agent-monitor-ui-v1';

function detectBasePath() {
  const path = window.location.pathname || '/';
  const clean = path.replace(/\/+$/, '') || '/';
  if (clean === '/' || clean === '/index.html') return '';
  if (clean.endsWith('/index.html')) return clean.replace(/\/index\.html$/, '');
  return clean;
}

const baseCandidates = (() => {
  const detected = detectBasePath();
  if (detected) {
    return detected === '/agent-monitor' ? [detected, ''] : [detected, '/agent-monitor', ''];
  }
  return ['', '/agent-monitor'];
})();

async function fetchJsonWithFallback(endpoint) {
  let lastErr = null;
  for (const base of baseCandidates) {
    const url = `${base}${endpoint}`;
    try {
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText} (${url})`);
      return await resp.json();
    } catch (err) {
      lastErr = err;
    }
  }
  throw lastErr || new Error('Request failed');
}

// Helpers
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function formatMs(ms) {
  if (!ms || ms < 0) return '-';
  const s = Math.floor(ms / 1000);
  if (s < 60) return s + 's';
  const m = Math.floor(s / 60);
  if (m < 60) return m + 'm ' + (s%60) + 's';
  return Math.floor(m/60) + 'h ' + (m%60) + 'm';
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function taskFirstLine(task) {
  for (const line of (task||'').split('\n')) {
    const clean = line.replace(/^#+\s*/, '').replace(/^\*\*.*?\*\*\s*/, '').trim();
    if (clean && clean.length > 5 && !clean.startsWith('Read ') && !clean.startsWith('**READ')) return clean;
  }
  return (task||'').slice(0, 120);
}

// API
async function fetchRuns(offset = 0, limit = PAGE_SIZE) {
  const params = new URLSearchParams({ offset: String(offset), limit: String(limit) });
  return fetchJsonWithFallback(`/api/runs?${params.toString()}`);
}

async function fetchAgents() {
  return fetchJsonWithFallback('/api/agents');
}

async function fetchRunDetail(runId) {
  return fetchJsonWithFallback(`/api/runs/${runId}`);
}


function fmtNum(n) {
  if (n === null || n === undefined || Number.isNaN(n)) return '-';
  return new Intl.NumberFormat().format(n);
}

function formatTs(ts) {
  if (!ts) return '-';
  const d = new Date(ts);
  return d.toLocaleString();
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const st = JSON.parse(raw);
    if (st.currentView === 'list' || st.currentView === 'lanes') currentView = st.currentView;
    if (typeof st.activeAgent === 'string' || st.activeAgent === null) activeAgent = st.activeAgent;
    if (typeof st.statusFilter === 'string') statusFilter = st.statusFilter;
    if (typeof st.searchQuery === 'string') searchQuery = st.searchQuery;
    if (Number.isFinite(st.timeWindowHours)) timeWindowHours = st.timeWindowHours;
    if (Number.isFinite(st.refreshInterval)) {
      const sel = document.getElementById('refreshInterval');
      if (sel) sel.value = String(st.refreshInterval);
    }
  } catch (_) {}
}

function saveState() {
  try {
    const refreshInterval = parseInt(document.getElementById('refreshInterval')?.value || '10', 10);
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      currentView,
      activeAgent,
      statusFilter,
      searchQuery,
      timeWindowHours,
      refreshInterval
    }));
  } catch (_) {}
}

function getFilteredRuns() {
  let filtered = activeAgent ? runs.filter(r => r.agentId === activeAgent) : [...runs];
  if (statusFilter !== 'all') filtered = filtered.filter(r => r.status === statusFilter);
  if (timeWindowHours > 0) {
    const cutoff = Date.now() - (timeWindowHours * 3600 * 1000);
    filtered = filtered.filter(r => !r.startedAt || r.startedAt >= cutoff);
  }
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    filtered = filtered.filter(r => `${r.label || ''} ${r.task || ''} ${r.agentId || ''} ${r.model || ''}`.toLowerCase().includes(q));
  }
  return filtered;
}

function renderTokenDashboard(filtered) {
  const withTokens = filtered.filter(r => r.totalTokens != null || r.inputTokens != null || r.outputTokens != null);
  const input = withTokens.reduce((s, r) => s + (r.inputTokens || 0), 0);
  const output = withTokens.reduce((s, r) => s + (r.outputTokens || 0), 0);
  const total = withTokens.reduce((s, r) => s + (r.totalTokens || ((r.inputTokens || 0) + (r.outputTokens || 0))), 0);

  const byStatus = {};
  const byAgent = {};
  withTokens.forEach(r => {
    byStatus[r.status] = (byStatus[r.status] || 0) + (r.totalTokens || 0);
    byAgent[r.agentId] = (byAgent[r.agentId] || 0) + (r.totalTokens || 0);
  });

  const topRows = obj => Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v]) => `<div class="row"><span>${esc(k)}</span><span>${fmtNum(v)}</span></div>`).join('') || '<div class="row"><span>No token data</span><span>-</span></div>';

  document.getElementById('tokenDashboard').innerHTML = `
    <div class="token-breakdown"><div class="title">Tokens (window)</div>
      <div class="row"><span>Runs with token data</span><span>${withTokens.length}/${filtered.length}</span></div>
      <div class="row"><span>Input</span><span>${fmtNum(input)}</span></div>
      <div class="row"><span>Output</span><span>${fmtNum(output)}</span></div>
      <div class="row"><span>Total</span><span>${fmtNum(total)}</span></div>
    </div>
    <div class="token-breakdown"><div class="title">By status (total tokens)</div>${topRows(byStatus)}</div>
    <div class="token-breakdown"><div class="title">By agent (total tokens)</div>${topRows(byAgent)}</div>
  `;
}

// Render
function renderStats() {

  const filtered = getFilteredRuns();
  const running = filtered.filter(r => r.status === 'running').length;
  const done = filtered.filter(r => r.status === 'done').length;
  const failed = filtered.filter(r => r.status === 'failed').length;
  const timedout = filtered.filter(r => r.status === 'timeout').length;
  const totalRuntime = filtered.reduce((s, r) => s + (r.runtimeMs || 0), 0);

  document.getElementById('stats').innerHTML = `
    <div class="stat"><div class="label">Running</div><div class="value" style="color:var(--green)">${running}</div></div>
    <div class="stat"><div class="label">Completed</div><div class="value" style="color:var(--blue)">${done}</div></div>
    <div class="stat"><div class="label">Failed</div><div class="value" style="color:var(--red)">${failed}</div></div>
    <div class="stat"><div class="label">Timed Out</div><div class="value" style="color:var(--amber)">${timedout}</div></div>
    <div class="stat"><div class="label">Total Runtime</div><div class="value">${formatMs(totalRuntime)}</div></div>
  `;
  renderTokenDashboard(filtered);
}

function renderAgentSidebar() {
  const counts = {};
  const activeCounts = {};
  runs.forEach(r => {
    counts[r.agentId] = (counts[r.agentId] || 0) + 1;
    if (r.status === 'running') activeCounts[r.agentId] = (activeCounts[r.agentId] || 0) + 1;
  });

  const agentColors = {
    'main': 'var(--blue)',
    'dev-ios': 'var(--green)',
    'dev-android': 'var(--amber)',
    'dev-api': 'var(--purple)',
    'dev-flutter': 'var(--red)',
  };

  let html = `<div class="agent-item ${!activeAgent ? 'active' : ''}" onclick="filterAgent(null)">
    <div class="dot" style="background:var(--text-3)"></div>
    All
    <span class="count">${runs.length}</span>
  </div>`;

  const seen = new Set();
  // Show agents that have runs first, then configured agents
  const agentIds = [...new Set([...runs.map(r => r.agentId), ...agents])];

  agentIds.forEach(id => {
    if (seen.has(id)) return;
    seen.add(id);
    const c = counts[id] || 0;
    const ac = activeCounts[id] || 0;
    const color = agentColors[id] || 'var(--text-3)';
    const dotStyle = ac > 0 ? `background:${color};box-shadow:0 0 6px ${color}` : `background:${color};opacity:0.3`;

    html += `<div class="agent-item ${activeAgent === id ? 'active' : ''}" onclick="filterAgent('${id}')">
      <div class="dot" style="${dotStyle}"></div>
      ${esc(id)}
      ${c > 0 ? `<span class="count">${c}</span>` : ''}
    </div>`;
  });

  document.getElementById('agentList').innerHTML = html;
}

function renderRunCard(r) {
  const preview = taskFirstLine(r.task);
  const isExpanded = expandedRuns[r.runId];
  const modelShort = (r.model || '').split('/').pop();

  return `
    <div class="run-card" id="run-${r.runId}">
      <div class="run-card-header" onclick="toggleRun('${r.runId}')">
        <div class="run-status">
          <span class="badge ${r.status}">
            ${r.status === 'running' ? '<div class="live-dot" style="width:5px;height:5px"></div>' : ''}
            ${r.status}
          </span>
          <span class="time">${formatMs(r.runtimeMs)}</span>
        </div>
        <div class="run-info">
          <div class="title-row">
            <span class="name">${esc(r.label || r.runId.slice(0,8))}</span>
            <span class="agent-tag">${esc(r.agentId)}</span>
            <span class="model-tag">${esc(modelShort)}</span>
          </div>
          <div class="task-preview">${esc(preview)}</div>
          <div class="token-chips">
            <span class="chip">in ${fmtNum(r.inputTokens)}</span>
            <span class="chip">out ${fmtNum(r.outputTokens)}</span>
            <span class="chip">total ${fmtNum(r.totalTokens)}</span>
            <span class="chip">start ${esc(formatTs(r.startedAt))}</span>
          </div>
        </div>
        <div class="run-meta">
          <span>${timeAgo(r.startedAt)}</span>
          ${r.endedAt ? `<span>took ${formatMs(r.runtimeMs)}</span>` : ''}
          ${r.timeoutSeconds ? `<span>timeout: ${r.timeoutSeconds}s</span>` : ''}
        </div>
      </div>
      <div class="run-detail ${isExpanded ? 'open' : ''}" id="detail-${r.runId}"></div>
    </div>
  `;
}

function renderListView() {
  const filtered = getFilteredRuns();
  const running = filtered.filter(r => r.status === 'running');
  const completed = filtered.filter(r => r.status !== 'running');

  let html = '';

  if (running.length > 0) {
    html += `<div class="section-header">Active <span class="pill">${running.length}</span></div>`;
    html += `<div class="run-list">${running.map(renderRunCard).join('')}</div>`;
  }

  if (completed.length > 0) {
    html += `<div class="section-header">History <span class="pill">${completed.length}</span></div>`;
    html += `<div class="run-list">${completed.map(renderRunCard).join('')}</div>`;
  }

  if (filtered.length === 0) {
    html = '<div class="empty">No agent runs found</div>';
  }

  if (!activeAgent && runs.length < runsTotal) {
    html += `<div style="display:flex;justify-content:center;margin:1rem 0 2rem">
      <button class="btn" onclick="loadMoreHistory()">Load older runs (${runs.length}/${runsTotal})</button>
    </div>`;
  }

  document.getElementById('content').innerHTML = html;
}

function renderLanesView() {
  const filtered = getFilteredRuns();

  // Group by agentId
  const groups = {};
  filtered.forEach(r => {
    if (!groups[r.agentId]) groups[r.agentId] = [];
    groups[r.agentId].push(r);
  });

  const agentColors = {
    'main': 'var(--blue)',
    'dev-ios': 'var(--green)',
    'dev-android': 'var(--amber)',
    'dev-api': 'var(--purple)',
    'dev-flutter': 'var(--red)',
  };

  let html = '<div class="lanes">';
  for (const [agentId, agentRuns] of Object.entries(groups)) {
    const color = agentColors[agentId] || 'var(--text-3)';
    html += `
      <div class="lane">
        <div class="lane-header">
          <span class="lane-name" style="color:${color}">${esc(agentId)}</span>
          <span class="lane-count">${agentRuns.length} runs</span>
        </div>
        <div class="lane-body">
          ${agentRuns.map(r => `
            <div class="lane-card" onclick="toggleRun('${r.runId}')">
              <div class="lc-top">
                <span class="lc-label">${esc(r.label || r.runId.slice(0,8))}</span>
                <span class="badge ${r.status}" style="font-size:0.6rem;padding:0.1rem 0.4rem">
                  ${r.status === 'running' ? '<div class="live-dot" style="width:4px;height:4px"></div>' : ''}
                  ${r.status}
                </span>
              </div>
              <div class="lc-task">${esc(taskFirstLine(r.task))}</div>
              <div class="lc-bottom">
                <span>${(r.model||'').split('/').pop()}</span>
                <span>•</span>
                <span>${formatMs(r.runtimeMs)}</span>
                <span>•</span>
                <span>${timeAgo(r.startedAt)}</span>
                <span>•</span>
                <span>tok ${fmtNum(r.totalTokens)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `;
  }
  html += '</div>';

  if (Object.keys(groups).length === 0) {
    html = '<div class="empty">No agent runs found</div>';
  }

  document.getElementById('content').innerHTML = html;
}

async function toggleRun(runId) {
  if (expandedRuns[runId]) {
    expandedRuns[runId] = false;
    const el = document.getElementById(`detail-${runId}`);
    if (el) { el.classList.remove('open'); el.innerHTML = ''; }
    return;
  }

  expandedRuns[runId] = true;
  const el = document.getElementById(`detail-${runId}`);
  if (el) {
    el.classList.add('open');
    el.innerHTML = '<div style="padding:1rem;color:var(--text-3);font-size:0.8rem">Loading...</div>';

    try {
      const detail = await fetchRunDetail(runId);
      let html = '';

      // Run statistics
      html += `<div class="detail-section">
        <div class="detail-label">Run Stats</div>
        <div class="detail-prompt">status: ${esc(detail.status || '-')}
started: ${esc(formatTs(detail.startedAt))}
ended: ${esc(formatTs(detail.endedAt))}
duration: ${esc(formatMs(detail.runtimeMs))}
input tokens: ${esc(String(detail.inputTokens ?? '-'))}
output tokens: ${esc(String(detail.outputTokens ?? '-'))}
total tokens: ${esc(String(detail.totalTokens ?? '-'))}</div>
      </div>`;

      // Full prompt
      html += `<div class="detail-section">
        <div class="detail-label">Full Prompt</div>
        <div class="detail-prompt">${esc(detail.task || 'No task recorded')}</div>
      </div>`;

      // Outcome
      html += `<div class="detail-section">
        <div class="detail-label">Outcome</div>
        <div class="detail-prompt">${esc(JSON.stringify(detail.outcome, null, 2))}</div>
      </div>`;

      // Transcript
      if (detail.messages && detail.messages.length > 0) {
        html += `<div class="detail-section">
          <div class="detail-label">Transcript (${detail.messages.length} messages)</div>`;

        detail.messages.forEach(msg => {
          html += `<div class="transcript-msg ${msg.role}">
            <div class="msg-role">${msg.role}</div>`;
          if (msg.text) {
            html += `<div class="msg-text">${esc(msg.text)}</div>`;
          }
          if (msg.toolCalls && msg.toolCalls.length > 0) {
            msg.toolCalls.forEach(tc => {
              html += `<span class="tool-call">${esc(tc.name)}</span> `;
            });
          }
          html += '</div>';
        });

        html += '</div>';
      } else {
        html += `<div class="detail-section">
          <div class="detail-label">Transcript</div>
          <div style="color:var(--text-3);font-size:0.8rem">No transcript available (session may have been cleaned up)</div>
        </div>`;
      }

      el.innerHTML = html;
    } catch (e) {
      el.innerHTML = `<div style="padding:1rem;color:var(--red);font-size:0.8rem">Failed to load: ${e.message}</div>`;
    }
  }
}

function setStatus(message = '', kind = 'info') {
  const banner = document.getElementById('statusBanner');
  if (!message) {
    banner.className = 'status-banner';
    banner.textContent = '';
    return;
  }
  banner.className = `status-banner ${kind}`;
  banner.textContent = message;
}

function render() {
  renderStats();
  renderAgentSidebar();
  if (currentView === 'list') renderListView();
  else renderLanesView();
  saveState();
}

// Actions
function filterAgent(id) {
  activeAgent = id;
  render();
}

function setView(v) {
  currentView = v;
  document.getElementById('viewList').classList.toggle('active', v === 'list');
  document.getElementById('viewLanes').classList.toggle('active', v === 'lanes');
  render();
}

function setRefreshInterval() {
  const val = parseInt(document.getElementById('refreshInterval').value);
  if (refreshTimer) clearInterval(refreshTimer);
  if (val > 0) refreshTimer = setInterval(refresh, val * 1000);
  saveState();
}

async function refresh() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = '↻ ...';
  try {
    const [runsResp, agentsResp] = await Promise.all([fetchRuns(0, PAGE_SIZE), fetchAgents()]);
    runs = Array.isArray(runsResp) ? runsResp : (runsResp.items || []);
    runsTotal = Array.isArray(runsResp) ? runs.length : (runsResp.total || runs.length);
    agents = Array.isArray(agentsResp) ? agentsResp : [];
    lastError = '';
    setStatus('');
    document.getElementById('lastUpdate').textContent = `updated ${new Date().toLocaleTimeString()} • showing ${runs.length}/${runsTotal}`;
    render();
    if (runs.length === 0) {
      setStatus('No runs found yet. Waiting for agent activity…', 'info');
    }
  } catch(e) {
    lastError = e?.message || String(e);
    console.error('Refresh failed:', e);
    setStatus(`Could not load runs. ${lastError}. Check proxy/base path and retry.`, 'error');
    if (runs.length === 0) {
      document.getElementById('stats').innerHTML = '';
      document.getElementById('agentList').innerHTML = '';
      document.getElementById('content').innerHTML = '<div class="empty">Unable to load data. Tap refresh or verify API route.</div>';
    }
  } finally {
    btn.disabled = false;
    btn.textContent = '↻ Refresh';
  }
}

async function loadMoreHistory() {
  try {
    const resp = await fetchRuns(runs.length, PAGE_SIZE);
    const more = Array.isArray(resp) ? [] : (resp.items || []);
    const existing = new Set(runs.map(r => r.runId));
    more.forEach(r => { if (!existing.has(r.runId)) runs.push(r); });
    runsTotal = Array.isArray(resp) ? runs.length : (resp.total || runsTotal);
    document.getElementById('lastUpdate').textContent = `updated ${new Date().toLocaleTimeString()} • showing ${runs.length}/${runsTotal}`;
    render();
  } catch (e) {
    console.error('Load more failed:', e);
  }
}

function clearFilters() {
  statusFilter = 'all';
  searchQuery = '';
  timeWindowHours = 24;
  document.getElementById('statusFilter').value = statusFilter;
  document.getElementById('searchInput').value = searchQuery;
  document.getElementById('timeWindow').value = String(timeWindowHours);
  render();
}

// Init
loadState();
document.getElementById('searchInput').value = searchQuery;
document.getElementById('statusFilter').value = statusFilter;
document.getElementById('timeWindow').value = String(timeWindowHours);
document.getElementById('viewList').classList.toggle('active', currentView === 'list');
document.getElementById('viewLanes').classList.toggle('active', currentView === 'lanes');
document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value.trim(); render(); });
document.getElementById('statusFilter').addEventListener('change', (e) => { statusFilter = e.target.value; render(); });
document.getElementById('timeWindow').addEventListener('change', (e) => { timeWindowHours = parseInt(e.target.value, 10) || 0; render(); });
setStatus('Loading runs…', 'info');
refresh();
setRefreshInterval();
</script>
</body>
</html>
