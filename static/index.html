<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Monitor</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="tailwind.css">
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }

  :root {
    --bg: #09090b;
    --surface: #111113;
    --surface-2: #1a1a1f;
    --surface-3: #222228;
    --border: #27272a;
    --border-hover: #3f3f46;
    --text: #fafafa;
    --text-2: #a1a1aa;
    --text-3: #71717a;
    --green: #22c55e;
    --green-bg: rgba(34,197,94,0.1);
    --amber: #f59e0b;
    --amber-bg: rgba(245,158,11,0.1);
    --red: #ef4444;
    --red-bg: rgba(239,68,68,0.1);
    --blue: #3b82f6;
    --blue-bg: rgba(59,130,246,0.1);
    --purple: #a855f7;
    --purple-bg: rgba(168,85,247,0.08);
    --surface-tint-1: rgba(255,255,255,0.03);
    --surface-tint-2: rgba(255,255,255,0.025);
    --surface-tint-3: rgba(255,255,255,0.02);
    --surface-tint-4: rgba(255,255,255,0.01);
    --surface-tint-0: rgba(255,255,255,0);
    --status-error-text: #fecaca;
    --status-info-text: #bfdbfe;
    --focus-ring: rgba(59,130,246,0.2);
    --sheet-backdrop: rgba(0,0,0,0.55);
    --sheet-shadow: -14px 0 36px rgba(0,0,0,0.45);
    --badge-stale-bg: rgba(244,63,94,0.12);
    --badge-stale-text: #fb7185;
    --accent-active-bg: linear-gradient(180deg, rgba(59,130,246,0.22), rgba(59,130,246,0.12));
    --accent-active-bg-soft: linear-gradient(180deg, rgba(59,130,246,0.22), rgba(59,130,246,0.08));
    --accent-active-border: rgba(59,130,246,0.42);
    --accent-active-border-soft: rgba(59,130,246,0.38);
    --accent-active-text: #dbeafe;
    --chart-blue: #60a5fa;
    --chart-green: #34d399;
    --chart-purple: #c084fc;
    --chart-amber: #f59e0b;
    --chart-red: #ef4444;
    --chart-teal: #14b8a6;
    --chart-orange: #f97316;
    --chart-yellow: #eab308;
    --mono: 'JetBrains Mono', monospace;
    --sans: 'Inter', system-ui, -apple-system, sans-serif;

    /* Spacing scale */
    --space-2xs: 0.25rem;  /* 4px */
    --space-xs: 0.5rem;    /* 8px */
    --space-sm: 0.75rem;   /* 12px */
    --space-md: 1rem;      /* 16px */
    --space-lg: 1.5rem;    /* 24px */
    --space-xl: 2rem;      /* 32px */

    --container-pad: var(--space-xl);
    --section-gap: var(--space-lg);
    --grid-gutter: var(--space-sm);
    color-scheme: dark;
  }

  :root[data-theme="light"] {
    --bg: #f7f8fb;
    --surface: #ffffff;
    --surface-2: #f2f4f8;
    --surface-3: #e8edf5;
    --border: #d7dde8;
    --border-hover: #b7c3d6;
    --text: #0f172a;
    --text-2: #334155;
    --text-3: #64748b;
    --green: #15803d;
    --green-bg: rgba(21,128,61,0.12);
    --amber: #b45309;
    --amber-bg: rgba(180,83,9,0.13);
    --red: #b91c1c;
    --red-bg: rgba(185,28,28,0.12);
    --blue: #1d4ed8;
    --blue-bg: rgba(29,78,216,0.11);
    --purple: #7e22ce;
    --purple-bg: rgba(126,34,206,0.1);
    --surface-tint-1: rgba(15,23,42,0.04);
    --surface-tint-2: rgba(15,23,42,0.03);
    --surface-tint-3: rgba(15,23,42,0.02);
    --surface-tint-4: rgba(15,23,42,0.015);
    --surface-tint-0: rgba(15,23,42,0);
    --status-error-text: #7f1d1d;
    --status-info-text: #1e3a8a;
    --focus-ring: rgba(29,78,216,0.2);
    --sheet-backdrop: rgba(15,23,42,0.25);
    --sheet-shadow: -14px 0 28px rgba(15,23,42,0.2);
    --badge-stale-bg: rgba(225,29,72,0.12);
    --badge-stale-text: #9f1239;
    --accent-active-bg: linear-gradient(180deg, rgba(29,78,216,0.16), rgba(29,78,216,0.08));
    --accent-active-bg-soft: linear-gradient(180deg, rgba(29,78,216,0.14), rgba(29,78,216,0.05));
    --accent-active-border: rgba(29,78,216,0.35);
    --accent-active-border-soft: rgba(29,78,216,0.28);
    --accent-active-text: #1e3a8a;
    --chart-blue: #2563eb;
    --chart-green: #16a34a;
    --chart-purple: #9333ea;
    --chart-amber: #d97706;
    --chart-red: #dc2626;
    --chart-teal: #0f766e;
    --chart-orange: #ea580c;
    --chart-yellow: #ca8a04;
    color-scheme: light;
  }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: var(--sans);
    min-height: 100vh;
  }

  .ui-control-reset {
    -webkit-appearance: none;
    appearance: none;
    margin: 0;
    box-sizing: border-box;
    line-height: 1;
    font: inherit;
  }

  /* Top bar */
  .topbar {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    padding: 0.8rem 2rem 0.7rem;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(180deg, var(--surface-tint-3), var(--surface-tint-0)) var(--surface);
    position: sticky;
    top: 0;
    z-index: 100;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 0.6rem;
    min-width: 0;
  }

  .brand-mark {
    width: 42px;
    height: 42px;
    flex-shrink: 0;
    border-radius: 8px;
    background: var(--surface-tint-1);
    border: 1px solid var(--border);
    padding: 4px;
  }

  .brand-copy {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 0.28rem;
    min-width: 0;
  }

  .topbar-left h1 { font-size: 1rem; font-weight: 650; letter-spacing: -0.01em; line-height: 1.05; }

  .subtitle-wrap {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    min-width: 0;
  }

  .topbar-left .subtitle {
    color: var(--text-3);
    font-size: 0.72rem;
    font-family: var(--mono);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: min(52vw, 420px);
  }

  .topbar-right {
    --header-control-height: 2rem;
    display: flex;
    align-items: center;
    gap: 0.55rem;
    flex-wrap: nowrap;
    justify-content: flex-end;
    margin-left: auto;
  }

  .header-controls-group {
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    background: linear-gradient(180deg, var(--surface-tint-2), var(--surface-tint-0)) var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.28rem;
  }

  .refresh-controls {
    display: flex;
    align-items: center;
    gap: 0.45rem;
    font-family: var(--mono);
    font-size: 0.72rem;
    color: var(--text-3);
  }

  .refresh-label { font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.04em; }

  .header-utility-btn {
    width: var(--header-control-height);
    min-width: var(--header-control-height);
    height: var(--header-control-height);
    min-height: var(--header-control-height);
    padding: 0;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    font-size: 0.88rem;
    font-weight: 600;
    line-height: 1;
  }

  .filters-toggle-btn {
    display: none;
    font-size: 0.66rem;
    letter-spacing: 0.02em;
    text-transform: uppercase;
    white-space: nowrap;
  }

  #refreshBtn {
    background: linear-gradient(180deg, var(--surface-tint-1), var(--surface-tint-0)) var(--surface-2);
  }

  select, button.btn {
    -webkit-appearance: none;
    appearance: none;
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: var(--mono);
    font-size: 0.75rem;
    padding: 0.4rem 0.75rem;
    min-height: 2rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.15s;
  }

  select:hover, button.btn:hover { border-color: var(--border-hover); background: var(--surface-3); }
  button.btn:disabled { opacity: 0.4; cursor: not-allowed; }

  .live-dot {
    width: 6px; height: 6px; border-radius: 50%;
    background: var(--green);
    box-shadow: 0 0 6px var(--green);
    animation: pulse 2s ease-in-out infinite;
  }

  @keyframes pulse { 0%,100% { opacity:1; } 50% { opacity:0.4; } }

  /* Layout */
  .layout {
    display: flex;
    min-height: calc(100vh - 53px);
  }

  /* Sidebar — agent lanes */
  .sidebar {
    width: 220px;
    border-right: 1px solid var(--border);
    background: var(--surface);
    padding: 1rem 0;
    flex-shrink: 0;
  }

  .sidebar-title {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
    padding: 0 1rem;
    margin-bottom: 0.75rem;
  }

  .agent-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    cursor: pointer;
    transition: background 0.15s;
    font-size: 0.85rem;
  }

  .agent-item:hover { background: var(--surface-2); }
  .agent-item.active { background: var(--surface-2); border-right: 2px solid var(--blue); }

  .agent-item .dot {
    width: 8px; height: 8px; border-radius: 50%;
    flex-shrink: 0;
  }

  .agent-item .count {
    margin-left: auto;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
    background: var(--surface-3);
    padding: 0.1rem 0.4rem;
    border-radius: 3px;
  }

  /* Main content */
  .main {
    flex: 1;
    padding: var(--section-gap) var(--container-pad);
    overflow-y: auto;
  }

  /* Stats row */
  .stats {
    display: grid;
    grid-template-columns: repeat(5, 1fr);
    gap: var(--grid-gutter);
    margin-bottom: var(--section-gap);
  }

  .stat {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem;
  }

  .stat .label { font-size: 0.7rem; color: var(--text-3); text-transform: uppercase; letter-spacing: 0.08em; }
  .stat .value { font-size: 1.75rem; font-weight: 700; font-family: var(--mono); margin-top: 0.25rem; }
  .stat .detail { font-size: 0.7rem; color: var(--text-3); font-family: var(--mono); margin-top: 0.15rem; }

  /* Run list */
  .section-header {
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
    font-size: 0.7rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
  }

  .section-header .pill {
    background: var(--surface-2);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 0.1rem 0.5rem;
    font-family: var(--mono);
  }

  .run-list { display: flex; flex-direction: column; gap: var(--space-sm); margin-bottom: var(--section-gap); }

  .run-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    transition: border-color 0.15s;
    cursor: pointer;
  }

  .run-card:hover { border-color: var(--border-hover); }

  .run-card-header {
    display: grid;
    grid-template-columns: 90px 1fr auto;
    gap: 1rem;
    padding: 1rem 1.25rem;
    align-items: center;
  }

  .run-status {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.25rem;
  }

  .badge {
    font-family: var(--mono);
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }

  .badge.running { background: var(--green-bg); color: var(--green); }
  .badge.done { background: var(--blue-bg); color: var(--blue); }
  .badge.failed { background: var(--red-bg); color: var(--red); }
  .badge.timeout { background: var(--amber-bg); color: var(--amber); }
  .badge.quiet { background: var(--amber-bg); color: var(--amber); }
  .badge.stalled { background: var(--badge-stale-bg); color: var(--badge-stale-text); }
  .badge.dead { background: var(--red-bg); color: var(--red); }
  .badge.unknown { background: var(--surface-3); color: var(--text-3); }

  .run-status .time {
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
  }

  .run-info { min-width: 0; }

  .run-info .title-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.25rem;
  }

  .run-info .name { font-weight: 600; font-size: 0.9rem; }

  .run-info .agent-tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    padding: 0.1rem 0.5rem;
    border-radius: 3px;
    background: var(--purple-bg);
    color: var(--purple);
  }

  .run-info .model-tag {
    font-family: var(--mono);
    font-size: 0.65rem;
    padding: 0.1rem 0.5rem;
    border-radius: 3px;
    background: var(--surface-3);
    color: var(--text-2);
  }

  .run-info .task-preview {
    font-size: 0.8rem;
    color: var(--text-2);
    line-height: 1.4;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .run-meta {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 0.2rem;
    font-family: var(--mono);
    font-size: 0.7rem;
    color: var(--text-3);
    white-space: nowrap;
  }

  /* Expanded detail */
  .run-detail {
    border-top: 1px solid var(--border);
    padding: 1.25rem;
    display: none;
  }

  .run-detail.open { display: block; }

  .detail-section {
    margin-bottom: 1.25rem;
  }

  .detail-section:last-child { margin-bottom: 0; }

  .detail-label {
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--text-3);
    margin-bottom: 0.5rem;
  }

  .detail-prompt {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: 1rem;
    font-family: var(--mono);
    font-size: 0.75rem;
    line-height: 1.6;
    color: var(--text-2);
    white-space: pre-wrap;
    word-break: break-word;
    max-height: 400px;
    overflow-y: auto;
  }

  .transcript-msg {
    padding: 0.75rem;
    border-radius: 6px;
    margin-bottom: 0.5rem;
    font-size: 0.8rem;
    line-height: 1.5;
  }

  .transcript-msg.assistant {
    background: var(--surface-2);
    border-left: 2px solid var(--blue);
  }

  .transcript-msg.user {
    background: var(--surface-2);
    border-left: 2px solid var(--green);
  }

  .transcript-msg .msg-role {
    font-family: var(--mono);
    font-size: 0.65rem;
    text-transform: uppercase;
    color: var(--text-3);
    margin-bottom: 0.25rem;
  }

  .transcript-msg .msg-text {
    color: var(--text-2);
    white-space: pre-wrap;
    word-break: break-word;
  }

  .tool-call {
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface-2);
    padding: 0.55rem;
    margin: 0.45rem 0;
  }
  .tool-call-head { display:flex; align-items:center; justify-content:space-between; gap:0.5rem; margin-bottom:0.4rem; }
  .tool-badge { font-family: var(--mono); font-size: 0.68rem; color: var(--amber); background: var(--amber-bg); padding: 0.15rem 0.45rem; border-radius: 4px; }
  .tool-block-label { font-size: 0.62rem; text-transform: uppercase; letter-spacing: 0.08em; color: var(--text-3); margin-bottom:0.15rem; }
  .tool-block-body { font-family: var(--mono); font-size: 0.72rem; white-space: pre-wrap; word-break: break-word; color: var(--text-2); }
  .tool-expand { margin-top:0.35rem; font-size:0.66rem; }

  .watchdog { margin-top:0.45rem; font-size:0.7rem; border-radius:6px; padding:0.35rem 0.45rem; border:1px solid var(--border); }
  .watchdog.ping { background: var(--amber-bg); color: var(--amber); }
  .watchdog.action { background: var(--red-bg); color: var(--red); }

  .empty {
    text-align: center;
    padding: 4rem 2rem;
    color: var(--text-3);
  }

  .status-banner {
    display: none;
    margin-bottom: var(--section-gap);
    padding: var(--space-sm) var(--space-md);
    border-radius: 8px;
    border: 1px solid var(--border);
    font-size: 0.8rem;
  }

  .status-banner.error {
    display: block;
    border-color: var(--red);
    background: var(--red-bg);
    color: var(--status-error-text);
  }

  .status-banner.info {
    display: block;
    border-color: var(--blue);
    background: var(--blue-bg);
    color: var(--status-info-text);
  }

  .filters {
    display: grid;
    grid-template-columns: minmax(0, 1.8fr) repeat(3, minmax(0, 1fr));
    gap: var(--grid-gutter);
    margin-bottom: var(--section-gap);
    padding: var(--space-sm);
    background: linear-gradient(180deg, var(--surface-tint-4), var(--surface-tint-0));
    border: 1px solid var(--border);
    border-radius: 10px;
  }

  .filter-field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
    min-width: 0;
  }

  .filter-label {
    font-family: var(--mono);
    font-size: 0.65rem;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    padding-left: 0.1rem;
  }

  .filters input,
  .filters select,
  .filters .btn {
    width: 100%;
    min-height: 2.35rem;
    border-radius: 8px;
    font-size: 0.78rem;
  }

  .filters input,
  .filters select {
    background: var(--surface-2);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 0.55rem 0.75rem;
  }

  .filters input::placeholder { color: var(--text-3); }
  .filters input:focus,
  .filters select:focus {
    outline: none;
    border-color: var(--blue);
    box-shadow: 0 0 0 2px var(--focus-ring);
  }

  .filter-clear {
    align-self: flex-end;
    background: var(--surface-2) !important;
    border-color: var(--border) !important;
    color: var(--text-2);
    font-weight: 600;
  }

  .filter-clear:hover { color: var(--text); border-color: var(--border-hover) !important; }

  .token-dashboard {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: var(--grid-gutter);
    margin-bottom: var(--section-gap);
  }

  .token-breakdown {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.75rem;
  }

  .token-breakdown .title {
    font-size: 0.7rem;
    color: var(--text-3);
    text-transform: uppercase;
    letter-spacing: 0.08em;
    margin-bottom: 0.5rem;
  }

  .token-breakdown .row {
    display:flex; justify-content:space-between; gap:0.5rem;
    font-family: var(--mono); font-size:0.72rem; color: var(--text-2);
    padding: 0.15rem 0;
  }

  .token-chips { display:flex; flex-wrap:wrap; gap:0.3rem; margin-top:0.4rem; }
  .chip {
    font-family: var(--mono);
    font-size: 0.62rem;
    border: 1px solid var(--border);
    border-radius: 999px;
    padding: 0.12rem 0.45rem;
    color: var(--text-2);
    background: var(--surface-2);
  }

  /* View toggle */
  .view-toggle {
    display: flex;
    gap: 0.25rem;
    border: 1px solid var(--border);
    border-radius: 8px;
    background: var(--surface);
    padding: 0.15rem;
    flex-shrink: 0;
  }

  .view-toggle button {
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-3);
    font-family: var(--mono);
    font-size: 0.7rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    padding: 0.42rem 0.72rem;
    height: var(--header-control-height);
    min-height: var(--header-control-height);
    border-radius: 6px;
    cursor: pointer;
  }

  .view-toggle button.active {
    background: var(--accent-active-bg);
    border-color: var(--accent-active-border);
    color: var(--accent-active-text);
  }
  .view-toggle button:hover { background: var(--surface-3); color: var(--text-2); }

  /* Lanes view */
  .lanes {
    display: flex;
    gap: var(--grid-gutter);
    overflow-x: auto;
    padding-bottom: var(--space-md);
  }

  .lane {
    min-width: 320px;
    max-width: 400px;
    flex-shrink: 0;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
  }

  .lane-header {
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--surface-2);
  }

  .lane-header .lane-name { font-weight: 600; font-size: 0.85rem; }
  .lane-header .lane-count { font-family: var(--mono); font-size: 0.7rem; color: var(--text-3); }

  .lane-body {
    padding: var(--space-sm);
    max-height: 70vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
  }

  .lane-card {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 6px;
    padding: var(--space-sm);
    cursor: pointer;
    transition: border-color 0.15s;
  }

  .lane-card:hover { border-color: var(--border-hover); }

  .lane-card .lc-top {
    display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.35rem;
  }

  .lane-card .lc-label { font-weight: 600; font-size: 0.8rem; }
  .lane-card .lc-task { font-size: 0.75rem; color: var(--text-2); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  .lane-card .lc-bottom { display: flex; align-items: center; gap: 0.5rem; margin-top: 0.35rem; font-family: var(--mono); font-size: 0.65rem; color: var(--text-3); }

  .page-nav {
    display: flex;
    gap: var(--space-2xs);
    padding: var(--space-xs) var(--container-pad);
    border-bottom: 1px solid var(--border);
    background: var(--surface);
  }

  .detail-sheet-backdrop {
    position: fixed;
    inset: 0;
    background: var(--sheet-backdrop);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    z-index: 180;
  }

  .detail-sheet {
    position: fixed;
    top: 0;
    right: 0;
    width: min(680px, 92vw);
    height: 100vh;
    background: var(--surface);
    border-left: 1px solid var(--border);
    transform: translateX(100%);
    transition: transform 0.24s ease;
    z-index: 190;
    display: flex;
    flex-direction: column;
    box-shadow: var(--sheet-shadow);
  }

  .detail-sheet.open { transform: translateX(0); }
  .detail-sheet-backdrop.open { opacity: 1; pointer-events: auto; }

  .detail-sheet-header {
    padding: 0.9rem 1rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.75rem;
    background: var(--surface-2);
  }

  .detail-sheet-title { font-weight: 600; font-size: 0.92rem; }

  .detail-sheet-close {
    border: 1px solid var(--border);
    background: var(--surface);
    color: var(--text-2);
    border-radius: 8px;
    width: 2rem;
    height: 2rem;
    cursor: pointer;
    font-size: 1rem;
    line-height: 1;
  }

  .detail-sheet-body {
    overflow-y: auto;
    padding: 1rem;
  }

  .page-link {
    background: transparent;
    border: 1px solid transparent;
    color: var(--text-3);
    border-radius: 8px;
    padding: 0.45rem 0.82rem;
    font-family: var(--mono);
    font-size: 0.73rem;
    font-weight: 600;
    letter-spacing: 0.02em;
    cursor: pointer;
    position: relative;
  }

  .page-link:hover { color: var(--text-2); background: var(--surface-2); }
  .page-link.active {
    color: var(--text);
    background: var(--accent-active-bg-soft);
    border-color: var(--accent-active-border-soft);
  }

  .daily-page { max-width: 1240px; margin: 0 auto; }
  .report-grid { display:grid; grid-template-columns: 1.1fr 1.1fr; gap:var(--grid-gutter); margin-bottom:var(--grid-gutter); }
  .report-card { background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:var(--space-sm); }
  .report-card h3 { font-size:0.78rem; text-transform:uppercase; letter-spacing:0.08em; color:var(--text-3); margin-bottom:0.6rem; }
  .chart-wrap { width:100%; overflow:hidden; }
  .chart-empty { color:var(--text-3); font-size:0.8rem; padding:1.5rem 0.4rem; text-align:center; }
  .report-table { width:100%; border-collapse:collapse; font-size:0.8rem; }
  .report-table th,.report-table td { border-bottom:1px solid var(--border); padding:0.48rem 0.28rem; text-align:left; }
  .report-table th { color:var(--text-3); font-size:0.66rem; text-transform:uppercase; letter-spacing:0.07em; }
  .report-table td.num { font-family:var(--mono); }
  .stack-legend { display:flex; gap:0.6rem; flex-wrap:wrap; margin-top:0.4rem; }
  .legend-item { font-size:0.68rem; color:var(--text-2); display:flex; align-items:center; gap:0.3rem; }
  .legend-swatch { width:10px; height:10px; border-radius:3px; }
  .metric-scope-label { margin-bottom: var(--space-sm); display:inline-flex; }

  /* ── Mobile ── */
  @media (max-width: 767px) {
    :root {
      --container-pad: var(--space-md);
      --section-gap: var(--space-md);
      --grid-gutter: var(--space-sm);
    }

    .page-nav { padding: var(--space-xs) var(--container-pad); overflow-x: auto; }
    .page-link { white-space: nowrap; }

    /* Stack layout vertically */
    .layout { flex-direction: column; min-height: auto; }

    /* Topbar: compact + grouped controls */
    .topbar {
      flex-direction: column;
      align-items: stretch;
      padding: 0.68rem 1rem 0.62rem;
      gap: 0.65rem;
    }

    .topbar-left {
      gap: 0.6rem;
      align-items: center;
    }

    .brand-mark {
      width: 36px;
      height: 36px;
      padding: 3px;
      border-radius: 7px;
    }

    .topbar-left h1 { font-size: 0.92rem; }
    .subtitle-wrap { gap: 0.4rem; }
    .topbar-left .subtitle {
      max-width: 100%;
      font-size: 0.68rem;
      line-height: 1.2;
    }

    .topbar-right {
      --mobile-header-control-height: 48px;
      --mobile-header-control-pad-x: 0.55rem;
      --mobile-header-control-pad-y: 0;
      width: 100%;
      display: grid;
      grid-template-columns: minmax(0, 1fr) auto auto;
      grid-template-areas:
        "mode mode mode"
        "interval theme refresh"
        "filters filters filters";
      gap: 0.4rem;
      align-items: center;
    }

    .header-controls-group {
      display: contents;
    }

    .view-toggle {
      grid-area: mode;
      width: 100%;
      padding: 0.14rem;
      border-color: var(--accent-active-border-soft);
      background: var(--surface-2);
    }

    .view-toggle button,
     .refresh-label,
    .refresh-controls select,
    .header-utility-btn.btn {
      height: var(--mobile-header-control-height);
      min-height: var(--mobile-header-control-height);
      box-sizing: border-box;
      line-height: 1;
      padding-top: var(--mobile-header-control-pad-y);
      padding-bottom: var(--mobile-header-control-pad-y);
    }

    .view-toggle button {
      padding-left: var(--mobile-header-control-pad-x);
      padding-right: var(--mobile-header-control-pad-x);
      font-size: 0.69rem;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .refresh-controls {
      grid-area: interval;
      min-width: 0;
      gap: 0;
    }

    .refresh-label {
      display: none;
      align-items: center;
      justify-content: center;
      padding-left: var(--mobile-header-control-pad-x);
      padding-right: var(--mobile-header-control-pad-x);
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface-2);
    }

    .refresh-controls select {
      min-width: 0;
      width: 100%;
      max-width: 92px;
      font-size: 0.69rem;
      padding-left: var(--mobile-header-control-pad-x);
      padding-right: calc(var(--mobile-header-control-pad-x) + 0.35rem);
      border-radius: 8px;
      appearance: none;
      -webkit-appearance: none;
      background-position: right 0.45rem center;
      line-height: 1;
    }

    #themeToggle { grid-area: theme; }
    #refreshBtn { grid-area: refresh; }

    .header-utility-btn {
      width: var(--mobile-header-control-height);
      min-width: var(--mobile-header-control-height);
      font-size: 0.82rem;
      flex-shrink: 0;
      padding-left: 0;
      padding-right: 0;
    }

    .filters-toggle-btn {
      grid-area: filters;
      display: inline-flex;
      justify-content: center;
      align-items: center;
      justify-self: start;
      min-height: 1.72rem;
      padding: 0 0.62rem;
      border-radius: 999px;
      font-size: 0.62rem;
    }

    #filters.collapsed-mobile {
      display: none;
    }

    /* Sidebar → horizontal scrollable pill bar */
    .sidebar {
      width: 100%;
      border-right: none;
      border-bottom: 1px solid var(--border);
      padding: 0;
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .sidebar::-webkit-scrollbar { display: none; }
    .sidebar-title { display: none; }
    #agentList {
      display: flex;
      flex-wrap: nowrap;
      padding: 0.5rem 0.75rem;
      gap: 0.25rem;
    }
    .sidebar .agent-item {
      flex-shrink: 0;
      white-space: nowrap;
      padding: 0.3rem 0.65rem;
      font-size: 0.75rem;
      border-radius: 6px;
      border-right: none !important;
    }
    .sidebar .agent-item.active {
      background: var(--surface-3);
      border-right: none !important;
      border-bottom: none;
    }

    /* Main content */
    .main { padding: var(--section-gap) var(--container-pad); }
    .filters {
      grid-template-columns: 1fr;
      gap: var(--grid-gutter);
      padding: var(--space-sm);
    }
    .filter-field { gap: 0.3rem; }
    .filters input,
    .filters select,
    .filters .btn { min-height: 2.5rem; font-size: 0.82rem; }
    .token-dashboard { grid-template-columns: 1fr; }

    /* Stats: 2×2 + 1 */
    .stats {
      grid-template-columns: 1fr 1fr;
      gap: var(--grid-gutter);
      margin-bottom: var(--section-gap);
    }
    .stat { padding: 0.75rem; }
    .stat .label { font-size: 0.6rem; }
    .stat .value { font-size: 1.4rem; }

    /* Run cards: stack the 3-col grid */
    .run-card-header {
      grid-template-columns: 1fr;
      gap: 0.5rem;
      padding: 0.85rem 1rem;
    }
    .run-status {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
    }
    .run-meta {
      flex-direction: row;
      align-items: center;
      gap: 0.75rem;
      flex-wrap: wrap;
    }
    .run-info .title-row { flex-wrap: wrap; gap: 0.35rem; }

    /* Lanes: stack vertically */
    .lanes { flex-direction: column; }
    .lane { min-width: 100%; max-width: 100%; }

    .detail-sheet {
      top: auto;
      bottom: 0;
      right: 0;
      left: 0;
      width: 100%;
      height: min(82vh, 760px);
      border-left: none;
      border-top: 1px solid var(--border);
      transform: translateY(100%);
    }
    .detail-sheet.open { transform: translateY(0); }

    /* Detail panels */
    .run-detail { padding: 0.85rem; }
    .detail-prompt { font-size: 0.7rem; max-height: 250px; }
  }

  @media (max-width: 400px) {
    :root {
      --container-pad: var(--space-sm);
      --section-gap: var(--space-sm);
      --grid-gutter: var(--space-xs);
    }

    .topbar { padding: 0.48rem 0.75rem; gap: 0.5rem; }
    .brand-mark { width: 31px; height: 31px; padding: 2px; border-radius: 6px; }
    .topbar-left h1 { font-size: 0.82rem; }
    .topbar-left .subtitle { font-size: 0.65rem; }
    .topbar-right { --mobile-header-control-height: 48px; --mobile-header-control-pad-x: 0.5rem; --mobile-header-control-pad-y: 0; gap: 0.34rem; }
    .view-toggle button { font-size: 0.64rem; }
    .refresh-controls select { max-width: 82px; font-size: 0.65rem; }
    .header-utility-btn { font-size: 0.72rem; }
    .filters-toggle-btn { font-size: 0.58rem; min-height: 1.64rem; padding: 0 0.55rem; }
    .main { padding: var(--section-gap) var(--container-pad); }
    .filters { padding: var(--space-xs); gap: var(--grid-gutter); }
    .filter-label { font-size: 0.6rem; }
    .stats { gap: var(--grid-gutter); }
    .stat { padding: 0.5rem; }
    .stat .value { font-size: 1.15rem; }
    .run-card-header { padding: 0.7rem; }
  }
</style>
</head>
<body>

<div class="topbar">
  <div class="topbar-left">
    <img class="brand-mark" src="logo.svg" alt="Agent Monitor logo" />
    <div class="brand-copy">
      <h1>Agent Monitor</h1>
      <div class="subtitle-wrap">
        <div class="live-dot" id="liveDot"></div>
        <span class="subtitle" id="lastUpdate"></span>
      </div>
    </div>
  </div>
  <div class="topbar-right">
    <div class="header-controls-group">
      <div class="view-toggle">
        <button class="active ui-control-reset ui-control-height inline-flex items-center justify-center px-3 md:px-3" onclick="setView('list')" id="viewList">List</button>
        <button class="ui-control-reset ui-control-height inline-flex items-center justify-center px-3 md:px-3" onclick="setView('lanes')" id="viewLanes">Lanes</button>
      </div>
      <div class="refresh-controls">
        <span class="refresh-label">Auto</span>
        <select class="ui-control-reset ui-control-height" id="refreshInterval" onchange="setRefreshInterval()">
          <option value="0">manual</option>
          <option value="5">5s</option>
          <option value="10" selected>10s</option>
          <option value="30">30s</option>
        </select>
      </div>
    </div>
    <button class="btn header-utility-btn ui-control-reset ui-control-height" id="themeToggle" onclick="toggleTheme()" aria-label="Toggle color theme" title="Toggle color theme">☾</button>
    <button class="btn header-utility-btn ui-control-reset ui-control-height" onclick="refresh()" id="refreshBtn" aria-label="Refresh runs" title="Refresh runs">↻</button>
    <button class="btn filters-toggle-btn" id="filtersToggle" type="button" aria-controls="filters" aria-expanded="true">Filters</button>
  </div>
</div>

<div class="page-nav">
  <button class="page-link active" id="pageMonitor" onclick="setPage('monitor')">Monitor</button>
  <button class="page-link" id="pageDaily" onclick="setPage('daily')">Reporting</button>
</div>

<div class="layout" id="monitorLayout">
  <div class="sidebar">
    <div class="sidebar-title">Agents</div>
    <div id="agentList"></div>
  </div>
  <div class="main" id="mainContent">
    <div id="statusBanner" class="status-banner"></div>
    <div class="stats" id="stats"></div>
    <div class="filters" id="filters">
      <div class="filter-field">
        <label class="filter-label" for="searchInput">Search</label>
        <input id="searchInput" placeholder="Search label, task, agent, or model" />
      </div>
      <div class="filter-field">
        <label class="filter-label" for="statusFilter">Status</label>
        <select id="statusFilter">
          <option value="all">all statuses</option>
          <option value="running">running</option>
          <option value="quiet">quiet</option>
          <option value="stalled">stalled</option>
          <option value="dead">dead</option>
          <option value="done">done</option>
        </select>
      </div>
      <div class="filter-field">
        <label class="filter-label" for="timeWindow">Time window</label>
        <select id="timeWindow">
          <option value="0">all time</option>
          <option value="1">last 1h</option>
          <option value="6">last 6h</option>
          <option value="24" selected>last 24h</option>
          <option value="168">last 7d</option>
        </select>
      </div>
      <div class="filter-field">
        <label class="filter-label">Actions</label>
        <button class="btn filter-clear" onclick="clearFilters()">Clear filters</button>
      </div>
    </div>
    <div class="token-dashboard" id="tokenDashboard"></div>
    <div id="content"></div>
  </div>
</div>

<div class="main daily-page" id="dailyPage" style="display:none;">
  <div class="filters">
    <div class="filter-field">
      <label class="filter-label" for="dailyWindow">Date window</label>
      <select id="dailyWindow">
        <option value="1" selected>last 24 hours</option>
        <option value="7">last 7 days</option>
        <option value="14">last 14 days</option>
        <option value="30">last 30 days</option>
        <option value="90">last 90 days</option>
      </select>
    </div>
    <div class="filter-field">
      <label class="filter-label" for="reportAgent">Agent</label>
      <select id="reportAgent"><option value="all">all agents</option></select>
    </div>
    <div class="filter-field">
      <label class="filter-label" for="reportStatus">Status</label>
      <select id="reportStatus">
        <option value="all">all statuses</option>
        <option value="running">running</option>
        <option value="done">done</option>
        <option value="failed">failed</option>
        <option value="timeout">timeout</option>
      </select>
    </div>
    <div class="filter-field">
      <label class="filter-label" for="reportScope">Metric scope</label>
      <select id="reportScope">
        <option value="completed">completed only</option>
        <option value="all" selected>all statuses</option>
        <option value="active">active only</option>
      </select>
    </div>
    <div class="filter-field">
      <label class="filter-label" for="includeRunning">Include running</label>
      <select id="includeRunning">
        <option value="0">no</option>
        <option value="1" selected>yes</option>
      </select>
    </div>
    <div class="filter-field">
      <label class="filter-label" for="includeStale">Include stale running</label>
      <select id="includeStale">
        <option value="0">no</option>
        <option value="1" selected>yes</option>
      </select>
    </div>
    <div class="filter-field">
      <label class="filter-label">Actions</label>
      <button class="btn" onclick="refreshDailyStats()">Reload reporting</button>
    </div>
  </div>
  <div class="chip metric-scope-label" id="metricScopeLabel"></div>
  <div class="stats" id="dailyStatsSummary"></div>
  <div class="report-grid" id="reportCharts"></div>
  <div class="report-grid" id="reportBreakdowns"></div>
</div>
</div>

<div id="detailSheetBackdrop" class="detail-sheet-backdrop" onclick="closeDetailSheet()"></div>
<aside id="detailSheet" class="detail-sheet" aria-hidden="true">
  <div class="detail-sheet-header">
    <div class="detail-sheet-title" id="detailSheetTitle">Run details</div>
    <button class="detail-sheet-close" onclick="closeDetailSheet()" aria-label="Close run details">✕</button>
  </div>
  <div id="detailSheetBody" class="detail-sheet-body"></div>
</aside>

<script>
let runs = [];
let agents = [];
let activeAgent = null; // null = all
let currentView = 'list';
let statusFilter = 'all';
let searchQuery = '';
let timeWindowHours = 24;
let refreshTimer = null;
let expandedRuns = {};
let runsTotal = 0;
let lastError = '';
let activePage = 'monitor';
let dailyWindowDays = 1;
let dailyStats = null;
let reportAgentFilter = "all";
let reportStatusFilter = "all";
let reportScope = "all";
let includeRunning = true;
let includeStaleRunning = true;
let staleMinutes = 15;
let metricSummary = null;
const hiddenAgentsInStack = new Set();
let stackedMetric = 'runtimeMs';
let activeSheetRunId = null;
let mobileFiltersCollapsed = false;
const detailCache = {};
const PAGE_SIZE = 200;
const QUIET_THRESHOLD_MS = 5 * 60 * 1000;
const STALLED_THRESHOLD_MS = 15 * 60 * 1000;
const PING_SUGGEST_THRESHOLD_MS = 10 * 60 * 1000;
const WATCHDOG_ACTION_THRESHOLD_MS = 20 * 60 * 1000;
const STORAGE_KEY = 'agent-monitor-ui-v1';
const THEME_STORAGE_KEY = 'agent-monitor-theme';
const MOBILE_FILTERS_PREF_KEY = 'agent-monitor-mobile-filters-collapsed';
const MOBILE_FILTERS_SEEN_KEY = 'agent-monitor-mobile-filters-seen';

function detectBasePath() {
  const path = window.location.pathname || '/';
  const clean = path.replace(/\/+$/, '') || '/';
  if (clean === '/' || clean === '/index.html') return '';
  if (clean.endsWith('/index.html')) return clean.replace(/\/index\.html$/, '');
  return clean;
}

const baseCandidates = (() => {
  const detected = detectBasePath();
  if (detected) {
    return detected === '/agent-monitor' ? [detected, ''] : [detected, '/agent-monitor', ''];
  }
  return ['', '/agent-monitor'];
})();

async function fetchJsonWithFallback(endpoint) {
  let lastErr = null;
  for (const base of baseCandidates) {
    const url = `${base}${endpoint}`;
    try {
      const resp = await fetch(url, { cache: 'no-store' });
      if (!resp.ok) throw new Error(`${resp.status} ${resp.statusText} (${url})`);
      return await resp.json();
    } catch (err) {
      lastErr = err;
    }
  }
  throw lastErr || new Error('Request failed');
}

function getSystemThemePreference() {
  try {
    return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches ? 'light' : 'dark';
  } catch (_) {
    return 'dark';
  }
}

function applyTheme(theme) {
  const normalized = theme === 'light' ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', normalized);
  const btn = document.getElementById('themeToggle');
  if (btn) {
    btn.textContent = normalized === 'light' ? '☀' : '☾';
    const nextModeLabel = normalized === 'light' ? 'Switch to dark mode' : 'Switch to light mode';
    btn.setAttribute('aria-label', nextModeLabel);
    btn.setAttribute('title', nextModeLabel);
  }
}

function initTheme() {
  let saved = null;
  try { saved = localStorage.getItem(THEME_STORAGE_KEY); } catch (_) {}
  const theme = saved === 'light' || saved === 'dark' ? saved : getSystemThemePreference();
  applyTheme(theme);
}

function toggleTheme() {
  const current = document.documentElement.getAttribute('data-theme') === 'light' ? 'light' : 'dark';
  const next = current === 'light' ? 'dark' : 'light';
  applyTheme(next);
  try { localStorage.setItem(THEME_STORAGE_KEY, next); } catch (_) {}
  if (activePage === 'daily') renderDailyStats();
}

function cssVar(name, fallback) {
  const val = getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  return val || fallback;
}

// Helpers
const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

function shortPayload(text, max = 260) {
  const s = String(text ?? '');
  if (!s) return '';
  return s.length > max ? `${s.slice(0, max)}…` : s;
}

function toggleToolPayload(btn, id) {
  const el = document.getElementById(id);
  if (!el) return;
  const expanded = el.getAttribute('data-expanded') === '1';
  el.setAttribute('data-expanded', expanded ? '0' : '1');
  btn.textContent = expanded ? 'expand' : 'collapse';
  const full = el.getAttribute('data-full') || '';
  el.textContent = expanded ? shortPayload(full) : full;
}

function formatMs(ms) {
  if (!ms || ms < 0) return '-';
  const s = Math.floor(ms / 1000);
  if (s < 60) return s + 's';
  const m = Math.floor(s / 60);
  if (m < 60) return m + 'm ' + (s%60) + 's';
  return Math.floor(m/60) + 'h ' + (m%60) + 'm';
}

function timeAgo(ts) {
  if (!ts) return '';
  const diff = Date.now() - ts;
  if (diff < 60000) return 'just now';
  if (diff < 3600000) return Math.floor(diff/60000) + 'm ago';
  if (diff < 86400000) return Math.floor(diff/3600000) + 'h ago';
  return Math.floor(diff/86400000) + 'd ago';
}

function taskFirstLine(task) {
  for (const line of (task||'').split('\n')) {
    const clean = line.replace(/^#+\s*/, '').replace(/^\*\*.*?\*\*\s*/, '').trim();
    if (clean && clean.length > 5 && !clean.startsWith('Read ') && !clean.startsWith('**READ')) return clean;
  }
  return (task||'').slice(0, 120);
}

function getLastActivityTs(run) {
  return run?.lastHeartbeatAt || run?.updatedAt || run?.startedAt || null;
}

function livenessStatus(run) {
  if (!run) return 'unknown';
  if (run.endedAt) return run.status === 'done' ? 'done' : 'dead';
  if (run.status === 'failed' || run.status === 'timeout') return 'dead';
  if (run.status !== 'running') return run.status || 'unknown';
  const lastTs = getLastActivityTs(run);
  if (!lastTs) return 'running';
  const age = Date.now() - lastTs;
  if (age < QUIET_THRESHOLD_MS) return 'running';
  if (age < STALLED_THRESHOLD_MS) return 'quiet';
  return 'stalled';
}

function isActiveRun(run) {
  const st = livenessStatus(run);
  return st === 'running' || st === 'quiet';
}

function effectiveStatus(run) {
  return livenessStatus(run);
}

function watchdogHint(run) {
  const st = livenessStatus(run);
  if (st !== 'quiet' && st !== 'stalled') return '';
  const lastTs = getLastActivityTs(run);
  if (!lastTs) return '';
  const age = Date.now() - lastTs;
  if (st === 'quiet' && age >= PING_SUGGEST_THRESHOLD_MS) return 'Ping suggested: no heartbeat for ~10m.';
  if (st === 'stalled' && age >= WATCHDOG_ACTION_THRESHOLD_MS) return 'Recommended action: steer or restart this run (or kill if unresponsive)';
  return '';
}

// API
async function fetchRuns(offset = 0, limit = PAGE_SIZE) {
  const params = new URLSearchParams({ offset: String(offset), limit: String(limit) });
  return fetchJsonWithFallback(`/api/runs?${params.toString()}`);
}

async function fetchAgents() {
  return fetchJsonWithFallback('/api/agents');
}

async function fetchRunDetail(runId) {
  return fetchJsonWithFallback(`/api/runs/${runId}`);
}

async function fetchDailyStats(days = dailyWindowDays) {
  const params = new URLSearchParams({
    days: String(days),
    agentId: reportAgentFilter,
    status: reportStatusFilter,
    scope: reportScope,
    includeRunning: includeRunning ? '1' : '0',
    includeStaleRunning: includeStaleRunning ? '1' : '0',
    staleMinutes: String(staleMinutes)
  });
  return fetchJsonWithFallback(`/api/reports/dashboard?${params.toString()}`);
}

async function fetchMetricSummary(days = dailyWindowDays) {
  const params = new URLSearchParams({
    days: String(days),
    agentId: reportAgentFilter,
    status: reportStatusFilter,
    scope: reportScope,
    includeRunning: includeRunning ? '1' : '0',
    includeStaleRunning: includeStaleRunning ? '1' : '0',
    staleMinutes: String(staleMinutes)
  });
  return fetchJsonWithFallback(`/api/metrics/summary?${params.toString()}`);
}

function fmtNum(n) {
  if (n === null || n === undefined || Number.isNaN(n)) return '-';
  return new Intl.NumberFormat().format(n);
}

function formatTs(ts) {
  if (!ts) return '-';
  const d = new Date(ts);
  return d.toLocaleString();
}

function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return;
    const st = JSON.parse(raw);
    if (st.currentView === 'list' || st.currentView === 'lanes') currentView = st.currentView;
    if (typeof st.activeAgent === 'string' || st.activeAgent === null) activeAgent = st.activeAgent;
    if (typeof st.statusFilter === 'string') statusFilter = st.statusFilter;
    if (typeof st.searchQuery === 'string') searchQuery = st.searchQuery;
    if (Number.isFinite(st.timeWindowHours)) timeWindowHours = st.timeWindowHours;
    if (st.activePage === 'monitor' || st.activePage === 'daily') activePage = st.activePage;
    if (Number.isFinite(st.dailyWindowDays)) dailyWindowDays = st.dailyWindowDays;
    if (typeof st.reportAgentFilter === 'string') reportAgentFilter = st.reportAgentFilter;
    if (typeof st.reportStatusFilter === 'string') reportStatusFilter = st.reportStatusFilter;
    if (typeof st.reportScope === 'string') reportScope = st.reportScope;
    includeRunning = !!st.includeRunning;
    includeStaleRunning = !!st.includeStaleRunning;
    if (Number.isFinite(st.refreshInterval)) {
      const sel = document.getElementById('refreshInterval');
      if (sel) sel.value = String(st.refreshInterval);
    }
  } catch (_) {}
}

function saveState() {
  try {
    const refreshInterval = parseInt(document.getElementById('refreshInterval')?.value || '10', 10);
    localStorage.setItem(STORAGE_KEY, JSON.stringify({
      currentView,
      activeAgent,
      statusFilter,
      searchQuery,
      timeWindowHours,
      activePage,
      dailyWindowDays,
      reportAgentFilter,
      reportStatusFilter,
      reportScope,
      includeRunning,
      includeStaleRunning,
      refreshInterval
    }));
  } catch (_) {}
}

function isMobileViewport() {
  return window.matchMedia && window.matchMedia('(max-width: 767px)').matches;
}

function applyMobileFiltersState() {
  const filters = document.getElementById('filters');
  const toggleBtn = document.getElementById('filtersToggle');
  if (!filters || !toggleBtn) return;

  const shouldCollapse = isMobileViewport() && mobileFiltersCollapsed;
  filters.classList.toggle('collapsed-mobile', shouldCollapse);
  toggleBtn.setAttribute('aria-expanded', shouldCollapse ? 'false' : 'true');
  toggleBtn.textContent = shouldCollapse ? 'Filters' : 'Hide filters';
}

function initMobileFiltersPreference() {
  try {
    const saved = localStorage.getItem(MOBILE_FILTERS_PREF_KEY);
    if (saved === '1' || saved === '0') {
      mobileFiltersCollapsed = saved === '1';
      return;
    }
    const seenBefore = localStorage.getItem(MOBILE_FILTERS_SEEN_KEY) === '1';
    mobileFiltersCollapsed = seenBefore;
    localStorage.setItem(MOBILE_FILTERS_SEEN_KEY, '1');
  } catch (_) {
    mobileFiltersCollapsed = false;
  }
}

function toggleFiltersVisibility() {
  mobileFiltersCollapsed = !mobileFiltersCollapsed;
  try { localStorage.setItem(MOBILE_FILTERS_PREF_KEY, mobileFiltersCollapsed ? '1' : '0'); } catch (_) {}
  applyMobileFiltersState();
}

function getFilteredRuns() {
  let filtered = activeAgent ? runs.filter(r => r.agentId === activeAgent) : [...runs];
  if (statusFilter !== 'all') filtered = filtered.filter(r => effectiveStatus(r) === statusFilter);
  if (timeWindowHours > 0) {
    const cutoff = Date.now() - (timeWindowHours * 3600 * 1000);
    filtered = filtered.filter(r => !r.startedAt || r.startedAt >= cutoff);
  }
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    filtered = filtered.filter(r => `${r.label || ''} ${r.task || ''} ${r.agentId || ''} ${r.model || ''}`.toLowerCase().includes(q));
  }
  return filtered;
}

function renderTokenDashboard(filtered) {
  const withTokens = filtered.filter(r => r.totalTokens != null || r.inputTokens != null || r.outputTokens != null);
  const input = withTokens.reduce((s, r) => s + (r.inputTokens || 0), 0);
  const output = withTokens.reduce((s, r) => s + (r.outputTokens || 0), 0);
  const total = withTokens.reduce((s, r) => s + (r.totalTokens || ((r.inputTokens || 0) + (r.outputTokens || 0))), 0);

  const byStatus = {};
  const byAgent = {};
  withTokens.forEach(r => {
    byStatus[r.status] = (byStatus[r.status] || 0) + (r.totalTokens || 0);
    byAgent[r.agentId] = (byAgent[r.agentId] || 0) + (r.totalTokens || 0);
  });

  const topRows = obj => Object.entries(obj).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([k,v]) => `<div class="row"><span>${esc(k)}</span><span>${fmtNum(v)}</span></div>`).join('') || '<div class="row"><span>No token data</span><span>-</span></div>';

  document.getElementById('tokenDashboard').innerHTML = `
    <div class="token-breakdown"><div class="title">Tokens (window)</div>
      <div class="row"><span>Runs with token data</span><span>${withTokens.length}/${filtered.length}</span></div>
      <div class="row"><span>Input</span><span>${fmtNum(input)}</span></div>
      <div class="row"><span>Output</span><span>${fmtNum(output)}</span></div>
      <div class="row"><span>Total</span><span>${fmtNum(total)}</span></div>
    </div>
    <div class="token-breakdown"><div class="title">By status (total tokens)</div>${topRows(byStatus)}</div>
    <div class="token-breakdown"><div class="title">By agent (total tokens)</div>${topRows(byAgent)}</div>
  `;
}

// Render
function renderStats() {

  const filtered = getFilteredRuns();
  const running = filtered.filter(r => effectiveStatus(r) === 'running').length;
  const quiet = filtered.filter(r => effectiveStatus(r) === 'quiet').length;
  const stalled = filtered.filter(r => effectiveStatus(r) === 'stalled').length;
  const dead = filtered.filter(r => effectiveStatus(r) === 'dead').length;
  const done = filtered.filter(r => effectiveStatus(r) === 'done').length;
  const totalRuntime = filtered.reduce((s, r) => s + (r.runtimeMs || 0), 0);

  document.getElementById('stats').innerHTML = `
    <div class="stat"><div class="label">Running</div><div class="value" style="color:var(--green)">${running}</div><div class="detail">active now</div></div>
    <div class="stat"><div class="label">Quiet</div><div class="value" style="color:var(--amber)">${quiet}</div><div class="detail">5-15m no heartbeat</div></div>
    <div class="stat"><div class="label">Stalled</div><div class="value" style="color:var(--badge-stale-text)">${stalled}</div><div class="detail">>15m no heartbeat</div></div>
    <div class="stat"><div class="label">Dead</div><div class="value" style="color:var(--red)">${dead}</div><div class="detail">exited / failed</div></div>
    <div class="stat"><div class="label">Done / Runtime</div><div class="value" style="font-size:1.2rem">${done} • ${formatMs(totalRuntime)}</div></div>
  `;
  renderTokenDashboard(filtered);
}

function renderSparkline(values, color = cssVar('--chart-blue', '#3b82f6'), height = 160) {
  if (!values.length || values.every(v => v <= 0)) return '<div class="chart-empty">No data in selected filters.</div>';
  const w = 620;
  const h = height;
  const maxV = Math.max(...values, 1);
  const step = values.length > 1 ? (w - 40) / (values.length - 1) : 0;
  const pts = values.map((v, i) => `${20 + i * step},${h - 20 - ((h - 40) * v / maxV)}`).join(' ');
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" preserveAspectRatio="none">
    <polyline fill="none" stroke="${color}" stroke-width="2.5" points="${pts}" />
    <polyline fill="${color}" fill-opacity="0.14" stroke="none" points="20,${h-20} ${pts} ${w-20},${h-20}" />
  </svg>`;
}

function renderBars(values, color = cssVar('--chart-green', '#22c55e'), height = 160) {
  if (!values.length || values.every(v => v <= 0)) return '<div class="chart-empty">No data in selected filters.</div>';
  const w = 620, h = height, maxV = Math.max(...values, 1), gap = 3;
  const bw = Math.max(3, ((w - 30) / values.length) - gap);
  const bars = values.map((v, i) => {
    const bh = ((h - 28) * v / maxV);
    const x = 16 + i * (bw + gap);
    const y = h - 16 - bh;
    return `<rect x="${x}" y="${y}" width="${bw}" height="${bh}" fill="${color}" rx="2" />`;
  }).join('');
  return `<svg viewBox="0 0 ${w} ${h}" width="100%" height="${h}" preserveAspectRatio="none">${bars}</svg>`;
}

function renderStacked(runtimeSplit, agentIds, colors, height = 190) {
  if (!runtimeSplit.length) return '<div class="chart-empty">No data in selected filters.</div>';
  const metricKey = stackedMetric || 'runtimeMs';
  const values = runtimeSplit.map(d => d.agents.reduce((s,a)=>s+Number(a[metricKey]||0),0));
  if (values.every(v => v <= 0)) return '<div class="chart-empty">No stacked data in selected filters.</div>';
  const w = 700, h = height, gap = 3;
  const maxV = Math.max(...values, 1);
  const bw = Math.max(6, ((w - 40) / runtimeSplit.length) - gap);
  let bars = '';
  let ticks = '';
  runtimeSplit.forEach((day, i) => {
    let yCursor = h - 18;
    const x = 20 + i * (bw + gap);
    agentIds.forEach((aid, idx) => {
      if (hiddenAgentsInStack.has(aid)) return;
      const item = (day.agents || []).find(a => a.agentId === aid);
      const v = item ? Number(item[metricKey] || 0) : 0;
      if (!v) return;
      const bh = ((h - 34) * v / maxV);
      yCursor -= bh;
      const tooltip = `${day.date} • ${aid} • ${metricKey === 'runCount' ? (fmtNum(v) + ' runs') : formatMs(v)}`;
      bars += `<rect data-day="${day.date}" data-agent="${aid}" x="${x}" y="${yCursor}" width="${bw}" height="${bh}" fill="${colors[idx % colors.length]}" rx="1"><title>${tooltip}</title></rect>`;
    });
    bars += `<rect data-day-hit="${day.date}" x="${x}" y="6" width="${bw}" height="${h-20}" fill="transparent" style="cursor:pointer"></rect>`;
    if (i % Math.max(1, Math.floor(runtimeSplit.length / 8)) === 0) {
      ticks += `<text x="${x + (bw/2)}" y="${h - 4}" text-anchor="middle" font-size="10" fill="${cssVar('--text-3', '#71717a')}">${day.date.slice(5)}</text>`;
    }
  });
  return `<svg id="stackedDailySvg" viewBox="0 0 ${w} ${h}" width="100%" height="${h}" preserveAspectRatio="none">${bars}${ticks}</svg>`;
}

function renderScopeLabel() {
  const el = document.getElementById('metricScopeLabel');
  if (!el) return;
  const scopeText = reportScope === 'completed' ? 'completed+failed+timeout' : (reportScope === 'active' ? 'running only' : 'all statuses');
  const run = metricSummary?.totals?.runCount ?? '-';
  const runtime = formatMs(metricSummary?.totals?.runtimeMs || 0);
  el.textContent = `Window: last ${dailyWindowDays}d • scope: ${scopeText} • include running: ${includeRunning ? 'yes' : 'no'} • include stale: ${includeStaleRunning ? 'yes' : 'no'} • runs: ${run} • runtime: ${runtime}`;
}

function wireStackedInteractions() {
  const svg = document.getElementById('stackedDailySvg');
  if (!svg) return;
  svg.querySelectorAll('rect[data-day-hit]').forEach(el => {
    el.addEventListener('click', () => {
      const day = el.getAttribute('data-day-hit');
      if (!day) return;
      setPage('monitor');
      timeWindowHours = dailyWindowDays * 24;
      const tw = document.getElementById('timeWindow');
      if (tw) tw.value = String(timeWindowHours);
      searchQuery = day;
      const search = document.getElementById('searchInput');
      if (search) search.value = day;
      render();
    });
  });
}

function renderDailyStats() {
  const summary = document.getElementById('dailyStatsSummary');
  const chartWrap = document.getElementById('reportCharts');
  const breakdownWrap = document.getElementById('reportBreakdowns');
  if (!dailyStats || !dailyStats.series) {
    summary.innerHTML = '';
    chartWrap.innerHTML = '<div class="report-card"><div class="chart-empty">No reporting data available yet.</div></div>';
    breakdownWrap.innerHTML = '';
    return;
  }

  const totals = dailyStats.totals || {};
  const statusDist = dailyStats.breakdowns?.statusDistribution || {};
  const runtimeTrend = dailyStats.series?.runtimeTrend || [];
  const runsTrend = dailyStats.series?.runsTrend || [];
  const tokenTrend = dailyStats.series?.tokenTrend || [];
  const split = dailyStats.series?.runtimeSplitByAgent || [];
  const topAgents = dailyStats.breakdowns?.topAgentsByRuntime || [];
  const avgRuntime = dailyStats.breakdowns?.avgRuntimeByAgent || [];
  const colors = [cssVar('--chart-blue', '#3b82f6'), cssVar('--chart-green', '#22c55e'), cssVar('--chart-amber', '#f59e0b'), cssVar('--chart-purple', '#a855f7'), cssVar('--chart-red', '#ef4444'), cssVar('--chart-teal', '#14b8a6'), cssVar('--chart-orange', '#f97316'), cssVar('--chart-yellow', '#eab308')];

  summary.innerHTML = `
    <div class="stat"><div class="label">Runs (window)</div><div class="value">${fmtNum(totals.runCount || 0)}</div></div>
    <div class="stat"><div class="label">Runtime (window)</div><div class="value">${formatMs(totals.runtimeMs || 0)}</div></div>
    <div class="stat"><div class="label">Agents</div><div class="value">${fmtNum((totals.agentCount ?? totals.agents) || 0)}</div></div>
    <div class="stat"><div class="label">Total Tokens</div><div class="value">${fmtNum(totals.totalTokens || 0)}</div><div class="detail">${fmtNum((totals.runsWithTokenData ?? totals.runsWithTokens) || 0)} runs with token data</div></div>
  `;

  chartWrap.innerHTML = `
    <div class="report-card"><h3>Runtime trend per day</h3><div class="chart-wrap">${renderSparkline(runtimeTrend.map(d => d.runtimeMs || 0), cssVar('--chart-blue', '#3b82f6'))}</div></div>
    <div class="report-card"><h3>Runs per day</h3><div class="chart-wrap">${renderBars(runsTrend.map(d => d.runCount || 0), cssVar('--chart-green', '#22c55e'))}</div></div>
    <div class="report-card"><h3>Daily usage by agent (stacked)</h3>
      <div style="display:flex;justify-content:flex-end;margin-bottom:0.4rem"><select id="stackedMetric" style="max-width:170px"><option value="runtimeMs">runtime</option><option value="runCount">run count</option></select></div>
      <div class="chart-wrap">${renderStacked(split, dailyStats.agentIds || [], colors)}</div>
      <div class="stack-legend">${(dailyStats.agentIds||[]).map((a,i)=>`<button type="button" class="legend-item" data-agent="${esc(a)}" style="background:transparent;border:1px solid var(--border);border-radius:999px;padding:0.12rem 0.45rem;cursor:pointer;opacity:${hiddenAgentsInStack.has(a)?0.45:1}"><span class="legend-swatch" style="background:${colors[i%colors.length]}"></span>${esc(a)}</button>`).join('')}</div>
    </div>
    <div class="report-card"><h3>Token trend (where available)</h3><div class="chart-wrap">${renderBars(tokenTrend.map(d => d.totalTokens || 0), cssVar('--chart-purple', '#a855f7'))}</div></div>
  `;

  breakdownWrap.innerHTML = `
    <div class="report-card"><h3>Top agents by runtime</h3><table class="report-table"><thead><tr><th>Agent</th><th>Runtime</th><th>Runs</th></tr></thead><tbody>
      ${(topAgents.length ? topAgents : []).map(a => `<tr><td>${esc(a.agentId)}</td><td class="num">${formatMs(a.runtimeMs)}</td><td class="num">${fmtNum(a.runCount)}</td></tr>`).join('') || '<tr><td colspan="3">No data</td></tr>'}
    </tbody></table></div>
    <div class="report-card"><h3>Success / fail / timeout distribution</h3><table class="report-table"><tbody>
      <tr><td>running</td><td class="num">${fmtNum(statusDist.running || 0)}</td></tr>
      <tr><td>done</td><td class="num">${fmtNum(statusDist.done || 0)}</td></tr>
      <tr><td>failed</td><td class="num">${fmtNum(statusDist.failed || 0)}</td></tr>
      <tr><td>timeout</td><td class="num">${fmtNum(statusDist.timeout || 0)}</td></tr>
    </tbody></table></div>
    <div class="report-card"><h3>Avg runtime per run by agent</h3><table class="report-table"><thead><tr><th>Agent</th><th>Avg runtime</th><th>Runs</th></tr></thead><tbody>
      ${(avgRuntime.length ? avgRuntime : []).slice(0,10).map(a => `<tr><td>${esc(a.agentId)}</td><td class="num">${formatMs(a.avgRuntimeMs)}</td><td class="num">${fmtNum(a.runCount)}</td></tr>`).join('') || '<tr><td colspan="3">No data</td></tr>'}
    </tbody></table></div>
  `;

  renderScopeLabel();
  const metricSel = document.getElementById('stackedMetric');
  if (metricSel) {
    metricSel.value = stackedMetric;
    metricSel.onchange = () => { stackedMetric = metricSel.value; renderDailyStats(); };
  }
  document.querySelectorAll('.stack-legend [data-agent]').forEach(btn => {
    btn.onclick = () => {
      const aid = btn.getAttribute('data-agent');
      if (hiddenAgentsInStack.has(aid)) hiddenAgentsInStack.delete(aid); else hiddenAgentsInStack.add(aid);
      renderDailyStats();
    };
  });
  wireStackedInteractions();
}


function renderAgentSidebar() {
  const counts = {};
  const activeCounts = {};
  runs.forEach(r => {
    counts[r.agentId] = (counts[r.agentId] || 0) + 1;
    if (isActiveRun(r)) activeCounts[r.agentId] = (activeCounts[r.agentId] || 0) + 1;
  });

  const agentColors = {
    'main': 'var(--blue)',
    'dev-ios': 'var(--green)',
    'dev-android': 'var(--amber)',
    'dev-api': 'var(--purple)',
    'dev-flutter': 'var(--red)',
  };

  let html = `<div class="agent-item ${!activeAgent ? 'active' : ''}" onclick="filterAgent(null)">
    <div class="dot" style="background:var(--text-3)"></div>
    All
    <span class="count">${runs.length}</span>
  </div>`;

  const seen = new Set();
  // Show agents that have runs first, then configured agents
  const agentIds = [...new Set([...runs.map(r => r.agentId), ...agents])];

  agentIds.forEach(id => {
    if (seen.has(id)) return;
    seen.add(id);
    const c = counts[id] || 0;
    const ac = activeCounts[id] || 0;
    const color = agentColors[id] || 'var(--text-3)';
    const dotStyle = ac > 0 ? `background:${color};box-shadow:0 0 6px ${color}` : `background:${color};opacity:0.3`;

    html += `<div class="agent-item ${activeAgent === id ? 'active' : ''}" onclick="filterAgent('${id}')">
      <div class="dot" style="${dotStyle}"></div>
      ${esc(id)}
      ${c > 0 ? `<span class="count">${c}</span>` : ''}
    </div>`;
  });

  document.getElementById('agentList').innerHTML = html;
}

function renderRunCard(r) {
  const preview = taskFirstLine(r.task);
  const isExpanded = expandedRuns[r.runId];
  const modelShort = (r.model || '').split('/').pop();
  const status = effectiveStatus(r);
  const hint = watchdogHint(r);

  return `
    <div class="run-card" id="run-${r.runId}">
      <div class="run-card-header" onclick="toggleRun('${r.runId}')">
        <div class="run-status">
          <span class="badge ${status}">
            ${status === 'running' ? '<div class="live-dot" style="width:5px;height:5px"></div>' : ''}
            ${status}
          </span>
          <span class="time">${formatMs(r.runtimeMs)}</span>
        </div>
        <div class="run-info">
          <div class="title-row">
            <span class="name">${esc(r.label || r.runId.slice(0,8))}</span>
            <span class="agent-tag">${esc(r.agentId)}</span>
            <span class="model-tag">${esc(modelShort)}</span>
          </div>
          <div class="task-preview">${esc(preview)}</div>
          <div class="token-chips">
            <span class="chip">in ${fmtNum(r.inputTokens)}</span>
            <span class="chip">out ${fmtNum(r.outputTokens)}</span>
            <span class="chip">total ${fmtNum(r.totalTokens)}</span>
            <span class="chip">start ${esc(formatTs(r.startedAt))}</span>
          </div>
          ${hint ? `<div class="watchdog ${status === 'stalled' ? 'action' : 'ping'}">${esc(hint)}</div>` : ''}
        </div>
        <div class="run-meta">
          <span>${timeAgo(r.startedAt)}</span>
          ${r.endedAt ? `<span>took ${formatMs(r.runtimeMs)}</span>` : ''}
          ${r.timeoutSeconds ? `<span>timeout: ${r.timeoutSeconds}s</span>` : ''}
        </div>
      </div>
      <div class="run-detail ${isExpanded ? 'open' : ''}" id="detail-${r.runId}"></div>
    </div>
  `;
}

function renderListView() {
  const filtered = getFilteredRuns();
  const running = filtered.filter(r => isActiveRun(r));
  const completed = filtered.filter(r => !isActiveRun(r));

  let html = '';

  if (running.length > 0) {
    html += `<div class="section-header">Active <span class="pill">${running.length}</span></div>`;
    html += `<div class="run-list">${running.map(renderRunCard).join('')}</div>`;
  }

  if (completed.length > 0) {
    html += `<div class="section-header">History <span class="pill">${completed.length}</span></div>`;
    html += `<div class="run-list">${completed.map(renderRunCard).join('')}</div>`;
  }

  if (filtered.length === 0) {
    html = '<div class="empty">No agent runs found</div>';
  }

  if (!activeAgent && runs.length < runsTotal) {
    html += `<div style="display:flex;justify-content:center;margin:1rem 0 2rem">
      <button class="btn" onclick="loadMoreHistory()">Load older runs (${runs.length}/${runsTotal})</button>
    </div>`;
  }

  document.getElementById('content').innerHTML = html;
}

function renderLanesView() {
  const filtered = getFilteredRuns();

  // Group by agentId
  const groups = {};
  filtered.forEach(r => {
    if (!groups[r.agentId]) groups[r.agentId] = [];
    groups[r.agentId].push(r);
  });

  const agentColors = {
    'main': 'var(--blue)',
    'dev-ios': 'var(--green)',
    'dev-android': 'var(--amber)',
    'dev-api': 'var(--purple)',
    'dev-flutter': 'var(--red)',
  };

  let html = '<div class="lanes">';
  for (const [agentId, agentRuns] of Object.entries(groups)) {
    const color = agentColors[agentId] || 'var(--text-3)';
    html += `
      <div class="lane">
        <div class="lane-header">
          <span class="lane-name" style="color:${color}">${esc(agentId)}</span>
          <span class="lane-count">${agentRuns.length} runs</span>
        </div>
        <div class="lane-body">
          ${agentRuns.map(r => {
            const status = effectiveStatus(r);
            return `
            <div class="lane-card" onclick="openDetailSheet('${r.runId}')">
              <div class="lc-top">
                <span class="lc-label">${esc(r.label || r.runId.slice(0,8))}</span>
                <span class="badge ${status}" style="font-size:0.6rem;padding:0.1rem 0.4rem">
                  ${status === 'running' ? '<div class="live-dot" style="width:4px;height:4px"></div>' : ''}
                  ${status}
                </span>
              </div>
              <div class="lc-task">${esc(taskFirstLine(r.task))}</div>
              <div class="lc-bottom">
                <span>${(r.model||'').split('/').pop()}</span>
                <span>•</span>
                <span>${formatMs(r.runtimeMs)}</span>
                <span>•</span>
                <span>${timeAgo(r.startedAt)}</span>
                <span>•</span>
                <span>tok ${fmtNum(r.totalTokens)}</span>
              </div>
            </div>
          `;
          }).join('')}
        </div>
      </div>
    `;
  }
  html += '</div>';

  if (Object.keys(groups).length === 0) {
    html = '<div class="empty">No agent runs found</div>';
  }

  document.getElementById('content').innerHTML = html;
}

function buildRunDetailHtml(detail) {
  let html = '';
  const status = effectiveStatus(detail);

  html += `<div class="detail-section">
    <div class="detail-label">Run stats</div>
    <div class="detail-prompt">status: ${esc(status || '-')}
started: ${esc(formatTs(detail.startedAt))}
ended: ${esc(formatTs(detail.endedAt))}
duration: ${esc(formatMs(detail.runtimeMs))}
last heartbeat: ${esc(formatTs(detail.lastHeartbeatAt))}
input tokens: ${esc(String(detail.inputTokens ?? '-'))}
output tokens: ${esc(String(detail.outputTokens ?? '-'))}
total tokens: ${esc(String(detail.totalTokens ?? '-'))}
model: ${esc(detail.model || '-')}
agent: ${esc(detail.agentId || '-')}
run id: ${esc(detail.runId || '-')}
session: ${esc(detail.sessionKey || '-')}</div>
  </div>`;

  const hint = watchdogHint(detail);
  if (hint) {
    html += `<div class="detail-section"><div class="watchdog ${status === 'stalled' ? 'action' : 'ping'}">${esc(hint)}${status === 'stalled' ? ' — APIs for direct actions are not exposed in this UI build yet.' : ''}</div></div>`;
  }

  html += `<div class="detail-section">
    <div class="detail-label">Prompt / task</div>
    <div class="detail-prompt">${esc(detail.task || 'No task recorded')}</div>
  </div>`;

  html += `<div class="detail-section">
    <div class="detail-label">Outcome metadata</div>
    <div class="detail-prompt">${esc(JSON.stringify(detail.outcome, null, 2))}</div>
  </div>`;

  if (detail.messages && detail.messages.length > 0) {
    html += `<div class="detail-section">
      <div class="detail-label">Transcript (${detail.messages.length} messages)</div>`;
    detail.messages.forEach(msg => {
      html += `<div class="transcript-msg ${msg.role}">
        <div class="msg-role">${msg.role}</div>`;
      if (msg.text) html += `<div class="msg-text">${esc(msg.text)}</div>`;
      if (msg.toolCalls && msg.toolCalls.length > 0) {
        msg.toolCalls.forEach((tc, idx) => {
          const args = tc.args || '';
          const result = tc.result || '';
          const argsId = `tool-${detail.runId}-${msg.timestamp || 'na'}-${idx}-args`;
          const resultId = `tool-${detail.runId}-${msg.timestamp || 'na'}-${idx}-result`;
          const argsPreview = args ? shortPayload(args) : '(no args captured)';
          const resultPreview = result ? shortPayload(result) : '(no result captured)';
          html += `<div class="tool-call">
            <div class="tool-call-head"><span class="tool-badge">${esc(tc.name || 'tool')}</span></div>
            <div class="tool-block-label">Arguments</div>
            <div class="tool-block-body" id="${esc(argsId)}" data-full="${esc(args)}" data-expanded="0">${esc(argsPreview)}</div>
            ${args && args.length > 260 ? `<button class="btn tool-expand" onclick="toggleToolPayload(this, '${esc(argsId)}')">expand</button>` : ''}
            <div class="tool-block-label" style="margin-top:0.4rem;">Result</div>
            <div class="tool-block-body" id="${esc(resultId)}" data-full="${esc(result)}" data-expanded="0">${esc(resultPreview)}</div>
            ${result && result.length > 260 ? `<button class="btn tool-expand" onclick="toggleToolPayload(this, '${esc(resultId)}')">expand</button>` : ''}
          </div>`;
        });
      }
      html += '</div>';
    });
    html += '</div>';
  } else {
    html += `<div class="detail-section"><div class="detail-label">Transcript</div><div style="color:var(--text-3);font-size:0.8rem">No transcript available (session may have been cleaned up)</div></div>`;
  }

  return html;
}

async function ensureRunDetail(runId) {
  if (detailCache[runId]) return detailCache[runId];
  const detail = await fetchRunDetail(runId);
  detailCache[runId] = detail;
  return detail;
}

async function toggleRun(runId) {
  if (expandedRuns[runId]) {
    expandedRuns[runId] = false;
    const el = document.getElementById(`detail-${runId}`);
    if (el) { el.classList.remove('open'); el.innerHTML = ''; }
    return;
  }

  expandedRuns[runId] = true;
  const el = document.getElementById(`detail-${runId}`);
  if (!el) return;
  el.classList.add('open');
  el.innerHTML = '<div style="padding:1rem;color:var(--text-3);font-size:0.8rem">Loading...</div>';

  try {
    const detail = await ensureRunDetail(runId);
    el.innerHTML = buildRunDetailHtml(detail);
  } catch (e) {
    el.innerHTML = `<div style="padding:1rem;color:var(--red);font-size:0.8rem">Failed to load: ${e.message}</div>`;
  }
}

async function openDetailSheet(runId) {
  activeSheetRunId = runId;
  const sheet = document.getElementById('detailSheet');
  const backdrop = document.getElementById('detailSheetBackdrop');
  const title = document.getElementById('detailSheetTitle');
  const body = document.getElementById('detailSheetBody');
  const run = runs.find(r => r.runId === runId);
  title.textContent = run?.label || `Run ${runId.slice(0, 8)}`;
  body.innerHTML = '<div style="padding:0.75rem;color:var(--text-3);font-size:0.8rem">Loading…</div>';
  sheet.classList.add('open');
  backdrop.classList.add('open');
  sheet.setAttribute('aria-hidden', 'false');

  try {
    const detail = await ensureRunDetail(runId);
    if (activeSheetRunId !== runId) return;
    body.innerHTML = buildRunDetailHtml(detail);
  } catch (e) {
    body.innerHTML = `<div style="padding:0.75rem;color:var(--red);font-size:0.8rem">Failed to load: ${esc(e.message || e)}</div>`;
  }
}

function closeDetailSheet() {
  activeSheetRunId = null;
  const sheet = document.getElementById('detailSheet');
  const backdrop = document.getElementById('detailSheetBackdrop');
  sheet.classList.remove('open');
  backdrop.classList.remove('open');
  sheet.setAttribute('aria-hidden', 'true');
}

document.addEventListener('keydown', (event) => {
  if (event.key === 'Escape') closeDetailSheet();
});

function setStatus(message = '', kind = 'info') {
  const banner = document.getElementById('statusBanner');
  if (!message) {
    banner.className = 'status-banner';
    banner.textContent = '';
    return;
  }
  banner.className = `status-banner ${kind}`;
  banner.textContent = message;
}

function render() {
  document.getElementById('pageMonitor').classList.toggle('active', activePage === 'monitor');
  document.getElementById('pageDaily').classList.toggle('active', activePage === 'daily');
  document.getElementById('monitorLayout').style.display = activePage === 'monitor' ? 'flex' : 'none';
  document.getElementById('dailyPage').style.display = activePage === 'daily' ? 'block' : 'none';

  if (activePage === 'monitor') {
    renderStats();
    renderAgentSidebar();
    if (currentView === 'list') renderListView();
    else renderLanesView();
  } else {
    renderDailyStats();
  }
  saveState();
}

// Actions
function setPage(page) {
  activePage = page === 'daily' ? 'daily' : 'monitor';
  if (activePage !== 'monitor') closeDetailSheet();
  render();
  if (activePage === 'daily' && !dailyStats) refreshDailyStats();
}

function filterAgent(id) {
  activeAgent = id;
  render();
}

function setView(v) {
  currentView = v;
  if (v !== 'lanes') closeDetailSheet();
  document.getElementById('viewList').classList.toggle('active', v === 'list');
  document.getElementById('viewLanes').classList.toggle('active', v === 'lanes');
  render();
}

function setRefreshInterval() {
  const val = parseInt(document.getElementById('refreshInterval').value);
  if (refreshTimer) clearInterval(refreshTimer);
  if (val > 0) refreshTimer = setInterval(refresh, val * 1000);
  saveState();
}

async function refresh() {
  const btn = document.getElementById('refreshBtn');
  btn.disabled = true;
  btn.textContent = '↻';
  try {
    const [runsResp, agentsResp] = await Promise.all([fetchRuns(0, PAGE_SIZE), fetchAgents()]);
    runs = Array.isArray(runsResp) ? runsResp : (runsResp.items || []);
    runsTotal = Array.isArray(runsResp) ? runs.length : (runsResp.total || runs.length);
    agents = Array.isArray(agentsResp) ? agentsResp : [];
    lastError = '';
    setStatus('');
    document.getElementById('lastUpdate').textContent = `updated ${new Date().toLocaleTimeString()} • showing ${runs.length}/${runsTotal}`;
    render();
    if (activePage === 'daily') {
      await refreshDailyStats();
    }
    if (runs.length === 0) {
      setStatus('No runs found yet. Waiting for agent activity…', 'info');
    }
  } catch(e) {
    lastError = e?.message || String(e);
    console.error('Refresh failed:', e);
    setStatus(`Could not load runs. ${lastError}. Check proxy/base path and retry.`, 'error');
    if (runs.length === 0) {
      document.getElementById('stats').innerHTML = '';
      document.getElementById('agentList').innerHTML = '';
      document.getElementById('content').innerHTML = '<div class="empty">Unable to load data. Tap refresh or verify API route.</div>';
    }
  } finally {
    btn.disabled = false;
    btn.textContent = '↻';
  }
}

async function refreshDailyStats() {
  try {
    [dailyStats, metricSummary] = await Promise.all([
      fetchDailyStats(dailyWindowDays),
      fetchMetricSummary(dailyWindowDays)
    ]);
    const agentSel = document.getElementById('reportAgent');
    if (agentSel) {
      const current = reportAgentFilter || 'all';
      const ids = Array.from(new Set(['all', ...(agents || []), ...((dailyStats && dailyStats.agentIds) || [])]));
      agentSel.innerHTML = ids.map(id => `<option value="${esc(id)}">${esc(id === 'all' ? 'all agents' : id)}</option>`).join('');
      agentSel.value = ids.includes(current) ? current : 'all';
      reportAgentFilter = agentSel.value;
    }
    if (activePage === 'daily') renderDailyStats();
  } catch (e) {
    console.error('Reporting failed:', e);
    if (activePage === 'daily') {
      document.getElementById('dailyStatsSummary').innerHTML = '';
      document.getElementById('reportCharts').innerHTML = `<div class="report-card"><div class="chart-empty">Unable to load reporting: ${esc(e.message || e)}</div></div>`;
      document.getElementById('reportBreakdowns').innerHTML = '';
    }
  }
}

async function loadMoreHistory() {
  try {
    const resp = await fetchRuns(runs.length, PAGE_SIZE);
    const more = Array.isArray(resp) ? [] : (resp.items || []);
    const existing = new Set(runs.map(r => r.runId));
    more.forEach(r => { if (!existing.has(r.runId)) runs.push(r); });
    runsTotal = Array.isArray(resp) ? runs.length : (resp.total || runsTotal);
    document.getElementById('lastUpdate').textContent = `updated ${new Date().toLocaleTimeString()} • showing ${runs.length}/${runsTotal}`;
    render();
  } catch (e) {
    console.error('Load more failed:', e);
  }
}

function clearFilters() {
  statusFilter = 'all';
  searchQuery = '';
  timeWindowHours = 24;
  document.getElementById('statusFilter').value = statusFilter;
  document.getElementById('searchInput').value = searchQuery;
  document.getElementById('timeWindow').value = String(timeWindowHours);
  render();
}

// Init
initTheme();
loadState();
initMobileFiltersPreference();
document.getElementById('searchInput').value = searchQuery;
document.getElementById('statusFilter').value = statusFilter;
document.getElementById('timeWindow').value = String(timeWindowHours);
document.getElementById('dailyWindow').value = String(dailyWindowDays);
document.getElementById('reportStatus').value = reportStatusFilter;
document.getElementById('reportScope').value = reportScope;
document.getElementById('includeRunning').value = includeRunning ? '1' : '0';
document.getElementById('includeStale').value = includeStaleRunning ? '1' : '0';
document.getElementById('viewList').classList.toggle('active', currentView === 'list');
document.getElementById('viewLanes').classList.toggle('active', currentView === 'lanes');
document.getElementById('searchInput').addEventListener('input', (e) => { searchQuery = e.target.value.trim(); render(); });
document.getElementById('statusFilter').addEventListener('change', (e) => { statusFilter = e.target.value; render(); });
document.getElementById('timeWindow').addEventListener('change', (e) => { timeWindowHours = parseInt(e.target.value, 10) || 0; render(); });
document.getElementById('dailyWindow').addEventListener('change', async (e) => {
  dailyWindowDays = parseInt(e.target.value, 10) || 30;
  await refreshDailyStats();
  render();
});
document.getElementById('reportAgent').addEventListener('change', async (e) => {
  reportAgentFilter = e.target.value || 'all';
  await refreshDailyStats();
  render();
});
document.getElementById('reportStatus').addEventListener('change', async (e) => {
  reportStatusFilter = e.target.value || 'all';
  await refreshDailyStats();
  render();
});
document.getElementById('reportScope').addEventListener('change', async (e) => {
  reportScope = e.target.value || 'completed';
  await refreshDailyStats();
  render();
});
document.getElementById('includeRunning').addEventListener('change', async (e) => {
  includeRunning = e.target.value === '1';
  await refreshDailyStats();
  render();
});
document.getElementById('includeStale').addEventListener('change', async (e) => {
  includeStaleRunning = e.target.value === '1';
  await refreshDailyStats();
  render();
});
document.getElementById('filtersToggle').addEventListener('click', toggleFiltersVisibility);
window.addEventListener('resize', applyMobileFiltersState);
applyMobileFiltersState();
setStatus('Loading runs…', 'info');
render();
refresh();
refreshDailyStats();
setRefreshInterval();
</script>
</body>
</html>
